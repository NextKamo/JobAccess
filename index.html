<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JobAccess - Recruitment Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .view { display: none; }
        .view.active { display: block; }
        
        /* Modal styles */
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0;
            transform: translateY(20px) scale(0.95);
        }
        .modal-backdrop.active .modal-content {
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 500;
            text-transform: capitalize;
        }
        .status-applied { background-color: #e0f2fe; color: #0284c7; } /* sky-100, sky-600 */
        .status-viewed { background-color: #dbeafe; color: #3b82f6; } /* blue-100, blue-500 */
        .status-shortlisted { background-color: #d1fae5; color: #059669; } /* emerald-100, emerald-600 */
        .status-rejected { background-color: #fee2e2; color: #dc2626; } /* red-100, red-600 */
        .status-hired { background-color: #f0abfc; color: #c026d3; } /* fuchsia-200, fuchsia-700 */
        .status-interview { background-color: #e9d5ff; color: #9333ea; } /* purple-200, purple-700 */


        /* Password strength indicator */
        .strength-meter {
            display: flex;
            gap: 3px;
            height: 4px;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }
        .strength-meter div {
            flex-grow: 1;
            background-color: #e5e7eb; /* gray-200 */
            transition: background-color 0.3s ease;
        }
        .strength-meter.weak div:nth-child(-n+1) { background-color: #ef4444; } /* red-500 */
        .strength-meter.medium div:nth-child(-n+2) { background-color: #f59e0b; } /* amber-500 */
        .strength-meter.strong div:nth-child(-n+3) { background-color: #f59e0b; } /* amber-500 */
        .strength-meter.very-strong div { background-color: #10b981; } /* emerald-500 */

        .strength-criteria li {
            transition: color 0.3s ease;
        }
        .strength-criteria li.valid {
            color: #10b981; /* emerald-500 */
        }
        .strength-criteria li.invalid {
            color: #ef4444; /* red-500 */
        }
        .strength-criteria li.valid .check-icon { display: inline-block; }
        .strength-criteria li:not(.valid) .check-icon { display: none; }
        .strength-criteria li.valid .cross-icon { display: none; }
        .strength-criteria li:not(.valid) .cross-icon { display: inline-block; }

        /* Prevent background scroll when modal is open */
        .overflow-hidden {
            overflow: hidden;
        }
        
        /* For job list scrolling */
        .job-list-container {
            /* We use a fixed height on desktop and let it be natural on mobile */
            height: auto;
        }
        @media (min-width: 1024px) { /* lg breakpoint */
            .job-list-container {
                height: calc(100vh - 250px);
            }
        }
        /* Kanban board styles */
        .kanban-board {
            display: flex;
            gap: 1.5rem; /* gap-6 */
            overflow-x: auto;
            padding-bottom: 1rem; /* pb-4 */
        }
        .kanban-column {
            flex: 0 0 320px; /* w-80 */
            max-width: 320px;
        }
        .kanban-cards {
            min-height: 200px;
        }
        .kanban-card {
            cursor: grab;
        }
        .kanban-card:active {
            cursor: grabbing;
        }
        .kanban-card.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }
        .kanban-column.drag-over {
            background-color: #f3f4f6; /* gray-100 */
        }
        /* Toast styles */
        .toast {
            transition: all 0.5s ease-in-out;
            opacity: 0;
            transform: translateY(20px);
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body class="antialiased">
    <div id="app" class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-white shadow-sm sticky top-0 z-40">
            <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <a href="#" class="flex-shrink-0" onclick="handleNavigate('landing')">
                           <img src="JA-logo.png" alt="JobAccess Logo" class="h-8 w-auto">
                        </a>
                    </div>
                    <!-- Desktop Menu -->
                    <div class="hidden md:flex items-center">
                        <div id="nav-links" class="ml-10 flex items-baseline space-x-4"></div>
                        <div id="auth-section" class="ml-6 flex items-center">
                            <div id="auth-buttons"></div>
                            <div id="notification-menu" class="hidden ml-4 relative">
                                <button type="button" id="notification-button" class="p-2 rounded-full text-slate-500 hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                    <span class="sr-only">View notifications</span>
                                    <i data-lucide="bell" class="h-6 w-6"></i>
                                    <span id="notification-badge" class="hidden absolute -top-1 -right-1 h-5 w-5 rounded-full bg-red-600 text-white text-xs flex items-center justify-center"></span>
                                </button>
                                <div id="notification-dropdown" class="origin-top-right absolute right-0 mt-2 w-80 max-w-sm rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden" role="menu" aria-orientation="vertical">
                                    <!-- Notifications will be injected here -->
                                </div>
                            </div>
                            <div id="user-menu" class="hidden ml-4 relative">
                                <div>
                                    <button type="button" class="max-w-xs bg-white rounded-full flex items-center text-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" id="user-menu-button" aria-expanded="false" aria-haspopup="true">
                                        <span class="sr-only">Open user menu</span>
                                        <div id="user-avatar-container">
                                            <img id="user-avatar" class="h-9 w-9 rounded-full object-cover" src="" alt="User avatar">
                                        </div>
                                    </button>
                                </div>
                                <div id="user-dropdown" class="origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg py-1 bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden" role="menu" aria-orientation="vertical" aria-labelledby="user-menu-button">
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Mobile menu button -->
                    <div class="md:hidden">
                        <button id="mobile-menu-button" onclick="toggleMobileMenu()" type="button" class="inline-flex items-center justify-center p-2 rounded-md text-slate-400 hover:text-slate-500 hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500" aria-controls="mobile-menu" aria-expanded="false">
                            <span class="sr-only">Open main menu</span>
                            <i id="mobile-menu-open-icon" data-lucide="menu" class="block h-6 w-6"></i>
                            <i id="mobile-menu-close-icon" data-lucide="x" class="hidden h-6 w-6"></i>
                        </button>
                    </div>
                </div>
            </nav>
            <!-- Mobile menu, show/hide based on menu state. -->
            <div class="md:hidden hidden" id="mobile-menu">
                <div id="mobile-nav-links" class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                    <!-- Mobile nav links will be injected here -->
                </div>
                <div class="pt-4 pb-3 border-t border-slate-200">
                     <div id="mobile-user-info" class="hidden items-center px-5">
                         <div class="flex-shrink-0">
                            <img id="mobile-user-avatar" class="h-10 w-10 rounded-full object-cover" src="" alt="User avatar">
                         </div>
                         <div class="ml-3">
                             <div id="mobile-user-name" class="text-base font-medium leading-none text-gray-800"></div>
                             <div id="mobile-user-email" class="text-sm font-medium leading-none text-gray-500 mt-1"></div>
                         </div>
                         <button id="mobile-notification-button" type="button" class="ml-auto flex-shrink-0 bg-white p-1 text-slate-400 rounded-full hover:text-slate-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 relative">
                            <span class="sr-only">View notifications</span>
                            <i data-lucide="bell" class="h-6 w-6"></i>
                            <span id="mobile-notification-badge" class="hidden absolute -top-1 -right-1 h-5 w-5 rounded-full bg-red-600 text-white text-xs flex items-center justify-center"></span>
                         </button>
                     </div>
                    <div id="mobile-auth-buttons" class="mt-3 px-2 space-y-1">
                        <!-- Mobile auth buttons will be injected here -->
                    </div>
                </div>
            </div>
        </header>


        <!-- Main Content -->
        <main class="flex-grow">
            <!-- Landing Page View -->
            <div id="landing-view" class="view"></div>
            <!-- Find Jobs View -->
            <div id="find-jobs-view" class="view"></div>
            <!-- Seeker Dashboard View -->
            <div id="seeker-dashboard-view" class="view"></div>
            <!-- Seeker Applications View -->
            <div id="seeker-applications-view" class="view"></div>
             <!-- Seeker Saved Jobs View -->
            <div id="seeker-saved-jobs-view" class="view"></div>
            <!-- Recruiter Main Dashboard View -->
            <div id="recruiter-dashboard-view" class="view"></div>
            <!-- Recruiter Job Postings View -->
            <div id="recruiter-jobs-view" class="view"></div>
            <!-- Recruiter Pipeline View -->
            <div id="recruiter-pipeline-view" class="view"></div>
            <!-- CV Database View -->
            <div id="cv-database-view" class="view"></div>
            <!-- Subscription View -->
            <div id="subscription-view" class="view"></div>
            <!-- Settings View -->
            <div id="settings-view" class="view"></div>
            <!-- Admin Dashboard View -->
            <div id="admin-dashboard-view" class="view"></div>
        </main>

        <!-- Footer -->
        <footer class="bg-slate-800 text-slate-300">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="flex flex-col sm:flex-row justify-between items-center">
                    <p class="text-sm text-slate-400 order-2 sm:order-1 mt-4 sm:mt-0">&copy; 2025 JobAccess. All rights reserved.</p>
                     <div class="flex space-x-6 order-1 sm:order-2">
                         <a href="#" class="text-slate-400 hover:text-white"><span class="sr-only">Twitter</span><i data-lucide="twitter"></i></a>
                         <a href="#" class="text-slate-400 hover:text-white"><span class="sr-only">Facebook</span><i data-lucide="facebook"></i></a>
                         <a href="#" class="text-slate-400 hover:text-white"><span class="sr-only">LinkedIn</span><i data-lucide="linkedin"></i></a>
                     </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Modals -->
    <div id="login-modal" class="modal-backdrop fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-md">
            <!-- Modal Content Loaded by JS -->
        </div>
    </div>
    
    <div id="job-details-modal" class="modal-backdrop fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
           <!-- Modal Content Loaded by JS -->
        </div>
    </div>
    
    <div id="applicants-modal" class="modal-backdrop fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
           <!-- Modal Content Loaded by JS -->
        </div>
    </div>

    <div id="post-job-modal" class="modal-backdrop fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
           <!-- Modal Content Loaded by JS -->
        </div>
    </div>

     <div id="confirmation-modal" class="modal-backdrop fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-md">
           <!-- Modal Content Loaded by JS -->
        </div>
    </div>

     <div id="report-job-modal" class="modal-backdrop fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-lg">
           <!-- Modal Content Loaded by JS -->
        </div>
    </div>
    
    <div id="candidate-details-modal" class="modal-backdrop fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
           <!-- Modal Content Loaded by JS -->
        </div>
    </div>
    
     <div id="cv-filter-modal" class="modal-backdrop fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-lg">
           <!-- Modal Content Loaded by JS -->
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed bottom-5 right-5 z-[100] space-y-3"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            sendPasswordResetEmail
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc,
            collection,
            addDoc,
            query,
            where,
            onSnapshot,
            Timestamp,
            orderBy,
            updateDoc,
            deleteDoc,
            getDocs
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDvev1lmFheeAmRFqKHPZyIW4tlfL1Xxhs",
            authDomain: "recruit-1ef6a.firebaseapp.com",
            projectId: "recruit-1ef6a",
            storageBucket: "recruit-1ef6a.firebasestorage.app",
            messagingSenderId: "1079473731321",
            appId: "1:1079473731321:web:3e0ae67d1cb6fe8a3cd428"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- SIMULATED DATE ---
        function getSimulatedNow() {
            // Current time is Tuesday, October 7, 2025 at 9:22 AM SAST (UTC+2)
            return new Date('2025-10-07T09:22:00+02:00');
        }

        // --- APPLICATION STATE ---
        const state = {
            currentUser: null, // { uid, email, name, type, initials, photoURL }
            currentView: 'landing',
            jobs: [],
            applications: [],
            notifications: [],
            candidates: [], // This will be populated from Firestore 'profiles' collection
            allUsers: {}, // For email fallback
            reports: [],
            savedJobs: [],
            selectedJobId: null,
            jobsCurrentPage: 1,
            jobsPerPage: 8,
            recruiterJobsCurrentPage: 1,
            recruiterJobsPerPage: 6,
            selectedRecruiterJobId: null,
            pipelineSelectedJobId: 'all', // 'all' or a specific job ID
            mobileShowDetails: false,
            settingsActiveTab: 'profile',
            adminActiveTab: 'overview',
            authLockoutActive: false,
            recruiterDashboardChart: null,
            seekerDashboardChart: null,
            adminDashboardChart: null,
            cvSearchTerm: '',
            cvFilters: {
                experience: 'any',
                location: '',
                jobType: [],
                skills: '',
            },
            selectedCvFile: null,
            newPhotoPreview: null,
        };

        // --- MOCK DATA ---
        function generateMockData() {
            // state.candidates is now populated from Firestore, so this function is for any other mock data if needed.
        }

        // --- DOM ELEMENTS ---
        const views = {
            landing: document.getElementById('landing-view'),
            findJobs: document.getElementById('find-jobs-view'),
            seekerDashboard: document.getElementById('seeker-dashboard-view'),
            seekerApplications: document.getElementById('seeker-applications-view'),
            seekerSavedJobs: document.getElementById('seeker-saved-jobs-view'),
            recruiterDashboard: document.getElementById('recruiter-dashboard-view'),
            recruiterJobs: document.getElementById('recruiter-jobs-view'),
            recruiterPipeline: document.getElementById('recruiter-pipeline-view'),
            cvDatabase: document.getElementById('cv-database-view'),
            subscription: document.getElementById('subscription-view'),
            settings: document.getElementById('settings-view'),
            adminDashboard: document.getElementById('admin-dashboard-view'),
        };
        const loginModalEl = document.getElementById('login-modal');
        const jobDetailsModalEl = document.getElementById('job-details-modal');
        const applicantsModalEl = document.getElementById('applicants-modal');
        const postJobModalEl = document.getElementById('post-job-modal');
        const confirmationModalEl = document.getElementById('confirmation-modal');
        const reportJobModalEl = document.getElementById('report-job-modal');
        const candidateDetailsModalEl = document.getElementById('candidate-details-modal');
        const cvFilterModalEl = document.getElementById('cv-filter-modal');

        function selectRecruiterJobAndNavigate(jobId) {
            state.selectedRecruiterJobId = jobId;
            handleNavigate('recruiterJobs');
        }

        // --- ROUTING / NAVIGATION ---
        function handleNavigate(view) {
            if (view === 'dashboard' && state.currentUser) {
                if (state.currentUser.type === 'admin') {
                    view = 'adminDashboard';
                } else {
                    view = state.currentUser.type === 'seeker' ? 'seekerDashboard' : 'recruiterDashboard';
                }
            }
             if (view === 'recruiterJobs') {
                state.recruiterJobsCurrentPage = 1; 
            }
            if (view === 'findJobs') {
                if (state.jobs.length > 0 && !state.selectedJobId) {
                     state.selectedJobId = state.jobs[0].id;
                }
                state.jobsCurrentPage = 1;
                state.mobileShowDetails = false;
            }
            if (view === 'settings' && state.currentUser) {
                state.settingsActiveTab = state.currentUser.type === 'seeker' ? 'profile' : 'companyProfile';
            }
            if (view === 'adminDashboard') {
                state.adminActiveTab = 'overview';
            }
            state.currentView = view;
            window.scrollTo(0, 0);
            updateUI();
        }

        // --- UI UPDATE & RENDERING ---
        function updateUI() {
            Object.values(views).forEach(v => {
                if (v) v.classList.remove('active');
            });
            if (views[state.currentView]) {
                views[state.currentView].classList.add('active');
            }

            switch (state.currentView) {
                case 'landing': renderLandingPage(); break;
                case 'findJobs': renderFindJobsPage(); break;
                case 'seekerDashboard': renderSeekerDashboard(); break;
                case 'seekerApplications': renderSeekerApplications(); break;
                case 'seekerSavedJobs': renderSeekerSavedJobs(); break;
                case 'recruiterDashboard': renderRecruiterDashboard(); break;
                case 'recruiterJobs': renderRecruiterJobsPage(); break;
                case 'recruiterPipeline': renderRecruiterPipelinePage(); break;
                case 'cvDatabase': renderCvDatabasePage(); break;
                case 'subscription': renderSubscriptionPage(); break;
                case 'settings': renderSettingsPage(); break;
                case 'adminDashboard': renderAdminDashboard(); break;
            }
            updateHeader();
        }

        function updateHeader() {
            // Desktop elements
            const navLinks = document.getElementById('nav-links');
            const authSection = document.getElementById('auth-section');
            const authButtons = document.getElementById('auth-buttons');
            const userMenu = document.getElementById('user-menu');
            const userAvatar = document.getElementById('user-avatar');
            const userDropdown = document.getElementById('user-dropdown');
            
            // Mobile elements
            const mobileNavLinks = document.getElementById('mobile-nav-links');
            const mobileAuthButtons = document.getElementById('mobile-auth-buttons');
            const mobileUserInfo = document.getElementById('mobile-user-info');
            const mobileUserAvatar = document.getElementById('mobile-user-avatar');
            const mobileUserName = document.getElementById('mobile-user-name');
            const mobileUserEmail = document.getElementById('mobile-user-email');

            // Notification elements
            const notificationMenu = document.getElementById('notification-menu');
            const notificationButton = document.getElementById('notification-button');
            const notificationDropdown = document.getElementById('notification-dropdown');
            const notificationBadge = document.getElementById('notification-badge');
            const mobileNotificationButton = document.getElementById('mobile-notification-button');
            const mobileNotificationBadge = document.getElementById('mobile-notification-badge');

            // --- Define Links based on state ---
            let links = [];
             if (!state.currentUser) {
                links = [ { text: 'Home', view: 'landing' }, { text: 'Find Jobs', view: 'findJobs' }];
            } else if (state.currentUser.type === 'seeker') {
                links = [ { text: 'Dashboard', view: 'dashboard' }, { text: 'My Applications', view: 'seekerApplications'}, { text: 'Find Jobs', view: 'findJobs' }];
            } else if (state.currentUser.type === 'recruiter') {
                links = [ { text: 'Dashboard', view: 'recruiterDashboard'}, { text: 'Job Postings', view: 'recruiterJobs' }, { text: 'Applicant Pipeline', view: 'recruiterPipeline' }, { text: 'CV Database', view: 'cvDatabase' }, { text: 'Subscription', view: 'subscription' }];
            } else if (state.currentUser.type === 'admin') {
                links = [ { text: 'Dashboard', view: 'adminDashboard' }];
            }
            
            // --- Update User Dropdown ---
            if(state.currentUser) {
                let dropdownHtml = `<p class="block px-4 py-2 text-sm text-gray-700 font-bold truncate">${state.currentUser.name}</p>`;
                if(state.currentUser.type === 'seeker'){
                    dropdownHtml += `<a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem" onclick="handleNavigate('dashboard')">Dashboard</a>`;
                    dropdownHtml += `<a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem" onclick="handleNavigate('seekerSavedJobs')">Saved Jobs</a>`;
                } else if (state.currentUser.type === 'recruiter') { // Recruiter
                     dropdownHtml += `<a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem" onclick="handleNavigate('recruiterDashboard')">Dashboard</a>`;
                } else { // Admin
                     dropdownHtml += `<a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem" onclick="handleNavigate('adminDashboard')">Dashboard</a>`;
                }
                dropdownHtml += `<a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem" onclick="handleNavigate('settings')">Settings</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem" onclick="handleLogout()">Sign out</a>`;
                userDropdown.innerHTML = dropdownHtml;
            }


            // --- Populate Desktop Menu ---
            navLinks.innerHTML = links.map(l => {
                const isActive = state.currentView === l.view || 
                                 (l.view === 'dashboard' && state.currentView === 'seekerDashboard') ||
                                 (l.view === 'dashboard' && state.currentView === 'recruiterDashboard') ||
                                 (l.view === 'dashboard' && state.currentView === 'adminDashboard');
                const classes = isActive 
                    ? 'text-indigo-600 font-semibold px-3 py-2 rounded-md text-sm' 
                    : 'text-gray-500 hover:text-indigo-600 px-3 py-2 rounded-md text-sm font-medium';
                return `<a href="#" class="${classes}" onclick="handleNavigate('${l.view}')">${l.text}</a>`;
            }).join('');

            // --- Populate Mobile Menu ---
            let mobileLinksHtml = links.map(l => {
                 const isActive = state.currentView === l.view || 
                                 (l.view === 'dashboard' && state.currentView === 'seekerDashboard') ||
                                 (l.view === 'dashboard' && state.currentView === 'recruiterDashboard') ||
                                 (l.view === 'dashboard' && state.currentView === 'adminDashboard');
                 const classes = isActive 
                    ? 'bg-indigo-50 text-indigo-700 block px-3 py-2 rounded-md text-base font-medium' 
                    : 'text-gray-700 hover:bg-gray-50 hover:text-indigo-600 block px-3 py-2 rounded-md text-base font-medium';
                return `<a href="#" class="${classes}" onclick="handleNavigate('${l.view}'); toggleMobileMenu();">${l.text}</a>`;
            }).join('');
            
            if(state.currentUser) {
                 const settingsActive = state.currentView === 'settings';
                 const settingsClasses = settingsActive 
                    ? 'bg-indigo-50 text-indigo-700 block px-3 py-2 rounded-md text-base font-medium'
                    : 'text-gray-700 hover:bg-gray-50 hover:text-indigo-600 block px-3 py-2 rounded-md text-base font-medium';
                
                 if(state.currentUser.type === 'seeker') {
                      const savedJobsActive = state.currentView === 'seekerSavedJobs';
                      const savedJobsClasses = savedJobsActive ? 'bg-indigo-50 text-indigo-700 block px-3 py-2 rounded-md text-base font-medium' : 'text-gray-700 hover:bg-gray-50 hover:text-indigo-600 block px-3 py-2 rounded-md text-base font-medium';
                      mobileLinksHtml += `<a href="#" class="${savedJobsClasses}" onclick="handleNavigate('seekerSavedJobs'); toggleMobileMenu();">Saved Jobs</a>`;
                 }
                
                 mobileLinksHtml += `<a href="#" class="${settingsClasses}" onclick="handleNavigate('settings'); toggleMobileMenu();">Settings</a>`;
                 mobileLinksHtml += `<a href="#" class="text-gray-700 hover:bg-gray-50 hover:text-indigo-600 block px-3 py-2 rounded-md text-base font-medium" onclick="handleLogout(); toggleMobileMenu();">Sign out</a>`;
            }
            mobileNavLinks.innerHTML = mobileLinksHtml;

            // --- Update Auth sections ---
            if (state.currentUser) {
                authButtons.classList.add('hidden');
                userMenu.classList.remove('hidden');
                userAvatar.src = state.currentUser.photoURL;
                userAvatar.onerror = () => { userAvatar.src = `https://placehold.co/100x100/6366f1/ffffff?text=${state.currentUser.initials}`; };
                
                mobileAuthButtons.classList.add('hidden');
                mobileUserInfo.classList.remove('hidden');
                mobileNotificationButton.classList.remove('hidden');
                mobileUserAvatar.src = state.currentUser.photoURL;
                mobileUserAvatar.onerror = () => { mobileUserAvatar.src = `https://placehold.co/100x100/6366f1/ffffff?text=${state.currentUser.initials}`; };
                mobileUserName.textContent = state.currentUser.name;
                mobileUserEmail.textContent = state.currentUser.email;

                // --- Handle Notifications ---
                notificationMenu.classList.remove('hidden');
                const unreadCount = state.notifications.filter(n => !n.isRead).length;
                
                if(unreadCount > 0) {
                    notificationBadge.textContent = unreadCount;
                    notificationBadge.classList.remove('hidden');
                    mobileNotificationBadge.textContent = unreadCount;
                    mobileNotificationBadge.classList.remove('hidden');
                } else {
                    notificationBadge.classList.add('hidden');
                    mobileNotificationBadge.classList.add('hidden');
                }

                notificationDropdown.innerHTML = `
                    <div class="px-4 py-3 border-b">
                        <p class="text-sm font-semibold text-slate-800">Notifications</p>
                    </div>
                    <div class="py-1 max-h-80 overflow-y-auto">
                        ${state.notifications.length > 0 ? state.notifications.map(n => {
                            const job = n.jobId ? state.jobs.find(j => j.id === n.jobId) : null;
                            const companyName = job ? job.company : '';
                            return `
                            <a href="#" onclick="handleNotificationClick('${n.link}', ${job ? `'${job.id}'` : null});" class="block px-4 py-3 text-sm text-slate-700 hover:bg-slate-50 ${!n.isRead ? 'bg-indigo-50' : ''}">
                                <p class="font-medium truncate">${n.message}</p>
                                <p class="text-xs text-slate-500 mt-1">${companyName ? `${companyName} • ` : ''}${timeAgo(n.timestamp)}</p>
                            </a>
                        `}).join('') : '<p class="p-4 text-sm text-slate-500">No new notifications.</p>'}
                    </div>
                `;

            } else {
                authButtons.classList.remove('hidden');
                userMenu.classList.add('hidden');
                notificationMenu.classList.add('hidden');
                userDropdown.classList.add('hidden'); // ensure user dropdown is hidden
                authButtons.innerHTML = `
                    <div class="relative" id="login-menu">
                         <button id="login-dropdown-button" class="bg-indigo-600 text-white font-medium px-4 py-2 rounded-lg shadow-sm hover:bg-indigo-700 transition-colors flex items-center gap-2">
                             <span>Login / Sign Up</span>
                             <i data-lucide="chevron-down" class="w-4 h-4"></i>
                         </button>
                         <div id="login-dropdown" class="origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden">
                             <div class="py-1" role="menu" aria-orientation="vertical">
                                 <a href="#" onclick="showLoginModal('seeker', 'login'); toggleLoginDropdown();" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">
                                     <i data-lucide="user" class="w-4 h-4 text-indigo-600"></i>
                                     <span>I'm a Job Seeker</span>
                                 </a>
                                 <a href="#" onclick="showLoginModal('recruiter', 'login'); toggleLoginDropdown();" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">
                                     <i data-lucide="briefcase" class="w-4 h-4 text-indigo-600"></i>
                                     <span>I'm a Recruiter</span>
                                 </a>
                             </div>
                         </div>
                    </div>
                `;

                mobileAuthButtons.classList.remove('hidden');
                mobileUserInfo.classList.add('hidden');
                mobileAuthButtons.innerHTML = `
                    <div class="px-2">
                         <button onclick="showLoginModal('seeker', 'login'); toggleMobileMenu();" class="w-full text-gray-700 font-medium px-4 py-3 rounded-lg hover:bg-gray-100 transition-colors text-center flex items-center justify-center gap-2">
                             <i data-lucide="user" class="w-5 h-5"></i>
                             <span>Job Seeker Login/Sign Up</span>
                         </button>
                         <button onclick="showLoginModal('recruiter', 'login'); toggleMobileMenu();" class="mt-3 w-full text-gray-700 font-medium px-4 py-3 rounded-lg hover:bg-gray-100 transition-colors text-center flex items-center justify-center gap-2">
                            <i data-lucide="briefcase" class="w-5 h-5"></i>
                            <span>Recruiter Login/Sign Up</span>
                         </button>
                    </div>
                `;
            }
            lucide.createIcons();
        }

        // --- COMPONENT RENDERERS ---

        function renderLandingPage() {
             const jobListingsHtml = state.jobs.slice(0, 3).map(job => {
                 const postedDate = timeAgo(job.postedDate);
                 const recruiter = state.allUsers[job.recruiterId];
                 const companyLogoUrl = recruiter?.photoURL || `https://placehold.co/100x100/e2e8f0/475569?text=${job.company.charAt(0)}`;
                 return `
                 <div class="bg-white p-6 rounded-xl border border-slate-200 hover:shadow-lg transition-shadow cursor-pointer" onclick="handleNavigate('findJobs'); selectJob('${job.id}');">
                     <div class="flex items-start gap-4">
                         <img src="${companyLogoUrl}" alt="${job.company} logo" class="w-12 h-12 rounded-lg object-cover flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/100x100/e2e8f0/475569?text=${job.company.charAt(0)}'"/>
                         <div class="flex-grow flex justify-between items-start">
                             <div>
                                 <h3 class="font-bold text-lg text-slate-800">${job.title}</h3>
                                 <p class="text-slate-600 font-medium">${job.company}</p>
                                 <p class="text-sm text-slate-500 mt-1">${job.location}</p>
                                 <p class="text-sm font-semibold text-emerald-600 mt-1">${job.salary || 'Market Related'}</p>
                             </div>
                             <div class="text-right flex-shrink-0">
                                 <span class="text-xs font-semibold text-indigo-700 bg-indigo-100 px-3 py-1 rounded-full">${job.type}</span>
                                 <p class="text-xs text-slate-400 mt-2">${postedDate}</p>
                             </div>
                         </div>
                     </div>
                 </div>
            `}).join('');

            views.landing.innerHTML = `
                <!-- Hero Section -->
                <div class="bg-white">
                    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-24 text-center">
                        <h1 class="text-4xl sm:text-5xl lg:text-6xl font-extrabold text-slate-900 tracking-tight">Find Your Next Big Opportunity</h1>
                        <p class="mt-4 max-w-2xl mx-auto text-lg text-slate-600">The premier platform for connecting top talent with innovative companies in South Africa.</p>
                        <div class="mt-8 max-w-2xl mx-auto flex flex-col sm:flex-row gap-4">
                            <input type="text" placeholder="Job title, keywords, or company" class="flex-grow w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
                            <button class="bg-indigo-600 text-white font-medium px-6 py-3 rounded-lg shadow-sm hover:bg-indigo-700 transition-colors" onclick="handleNavigate('findJobs')">Search Jobs</button>
                        </div>
                    </div>
                </div>

                <!-- Featured Jobs Section -->
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-16">
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="text-3xl font-bold text-slate-800">Featured Jobs</h2>
                        <a href="#" onclick="handleNavigate('findJobs')" class="font-medium text-indigo-600 hover:text-indigo-800">View all jobs &rarr;</a>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${jobListingsHtml}
                    </div>
                </div>

                <!-- How It Works Section -->
                <div class="bg-white py-16">
                    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                         <h2 class="text-3xl font-bold text-center text-slate-800 mb-12">How It Works</h2>
                         <div class="grid grid-cols-1 md:grid-cols-3 gap-12 text-center">
                             <div>
                                 <div class="bg-indigo-100 text-indigo-600 rounded-full h-16 w-16 flex items-center justify-center text-2xl font-bold mx-auto mb-4">1</div>
                                 <h3 class="font-semibold text-lg text-slate-800 mb-2">Create an Account</h3>
                                 <p class="text-slate-600">Whether you're a job seeker or a recruiter, signing up is quick and easy.</p>
                             </div>
                             <div>
                                 <div class="bg-indigo-100 text-indigo-600 rounded-full h-16 w-16 flex items-center justify-center text-2xl font-bold mx-auto mb-4">2</div>
                                 <h3 class="font-semibold text-lg text-slate-800 mb-2">Find or Post Jobs</h3>
                                 <p class="text-slate-600">Seekers can search for jobs, while recruiters post their vacancies.</p>
                             </div>
                             <div>
                                 <div class="bg-indigo-100 text-indigo-600 rounded-full h-16 w-16 flex items-center justify-center text-2xl font-bold mx-auto mb-4">3</div>
                                 <h3 class="font-semibold text-lg text-slate-800 mb-2">Get Connected</h3>
                                 <p class="text-slate-600">Apply for jobs or review applications to find the perfect match.</p>
                             </div>
                         </div>
                    </div>
                </div>
                
                 <!-- Call to Action Section -->
                <div class="bg-indigo-600">
                    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-16 text-center">
                        <h2 class="text-3xl font-bold text-white mb-4">Ready to Get Started?</h2>
                        <p class="text-indigo-200 mb-8 max-w-2xl mx-auto">Join thousands of job seekers and recruiters on the premier platform for talent in South Africa.</p>
                        <div class="flex flex-col sm:flex-row justify-center items-center gap-4">
                           <button onclick="showLoginModal('seeker', 'signup')" class="bg-white text-indigo-600 font-medium px-6 py-3 rounded-lg shadow-sm hover:bg-slate-100 transition-colors w-full sm:w-auto">Sign Up as a Job Seeker</button>
                           <button onclick="showLoginModal('recruiter', 'signup')" class="bg-indigo-700 text-white font-medium px-6 py-3 rounded-lg shadow-sm hover:bg-indigo-800 transition-colors w-full sm:w-auto">Post a Job for Free</button>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function selectJob(jobId) {
            state.selectedJobId = jobId;
            if (window.innerWidth < 1024) { // lg breakpoint
                state.mobileShowDetails = true;
            }
            renderFindJobsPage();
        }

        function showJobListOnMobile() {
            state.mobileShowDetails = false;
            renderFindJobsPage();
        }

        function changePage(page) {
            state.jobsCurrentPage = page;
            const indexOfLastJob = state.jobsCurrentPage * state.jobsPerPage;
            const indexOfFirstJob = indexOfLastJob - state.jobsPerPage;
            const currentJobs = state.jobs.slice(indexOfFirstJob, indexOfLastJob);
            if(currentJobs.length > 0) {
                state.selectedJobId = currentJobs[0].id;
            }
            renderFindJobsPage();
        }

        function renderFindJobsPage() {
            const indexOfLastJob = state.jobsCurrentPage * state.jobsPerPage;
            const indexOfFirstJob = indexOfLastJob - state.jobsPerPage;
            const currentJobs = state.jobs.slice(indexOfFirstJob, indexOfLastJob);
            const totalPages = Math.ceil(state.jobs.length / state.jobsPerPage);

            const jobListHtml = currentJobs.map(job => {
                const isSelected = job.id === state.selectedJobId;
                const recruiter = state.allUsers[job.recruiterId];
                const companyLogoUrl = recruiter?.photoURL || `https://placehold.co/100x100/e2e8f0/475569?text=${job.company.charAt(0)}`;
                const postedDate = timeAgo(job.postedDate);
                const isSaved = state.currentUser && state.savedJobs.includes(job.id);
                
                return `
                    <div class="p-4 rounded-lg cursor-pointer border-2 ${isSelected ? 'bg-white border-indigo-500 shadow-md' : 'bg-white border-transparent hover:border-slate-300'}" onclick="selectJob('${job.id}')">
                        <div class="flex items-start gap-4">
                            <img src="${companyLogoUrl}" alt="${job.company} logo" class="w-12 h-12 rounded-lg object-cover flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/100x100/e2e8f0/475569?text=${job.company.charAt(0)}'"/>
                            <div class="flex-grow">
                                <h3 class="font-bold text-slate-800">${job.title}</h3>
                                <p class="text-sm text-slate-600">${job.company}</p>
                                <p class="text-xs text-slate-500 mt-1">${job.location}</p>
                            </div>
                            <div class="text-right flex-shrink-0 flex flex-col items-end">
                                <p class="text-xs text-slate-400 mb-2">${postedDate}</p>
                                ${state.currentUser && state.currentUser.type === 'seeker' ? `<button onclick="event.stopPropagation(); handleSaveJob('${job.id}')" class="text-slate-400 hover:text-indigo-600">${isSaved ? '<i data-lucide="bookmark" class="w-5 h-5 text-indigo-600 fill-current"></i>' : '<i data-lucide="bookmark" class="w-5 h-5"></i>'}</button>` : ''}
                            </div>
                        </div>
                    </div>`;
            }).join('');
            
            let paginationHtml = '<div class="flex justify-center items-center gap-2 mt-4">';
            paginationHtml += `<button onclick="changePage(${state.jobsCurrentPage - 1})" ${state.jobsCurrentPage === 1 ? 'disabled' : ''} class="px-3 py-1 rounded-md bg-white border border-slate-300 text-sm font-medium text-slate-600 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">&laquo; Prev</button>`;
            for (let i = 1; i <= totalPages; i++) {
                paginationHtml += `<button onclick="changePage(${i})" class="px-3 py-1 rounded-md border text-sm font-medium ${state.jobsCurrentPage === i ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-slate-600 border-slate-300 hover:bg-slate-50'}">${i}</button>`;
            }
            paginationHtml += `<button onclick="changePage(${state.jobsCurrentPage + 1})" ${state.jobsCurrentPage === totalPages ? 'disabled' : ''} class="px-3 py-1 rounded-md bg-white border border-slate-300 text-sm font-medium text-slate-600 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">Next &raquo;</button></div>`;

            const selectedJob = state.jobs.find(j => j.id === state.selectedJobId);
            const recruiterForDetails = selectedJob ? state.allUsers[selectedJob.recruiterId] : null;
            const companyLogoUrlForDetails = recruiterForDetails?.photoURL || (selectedJob ? `https://placehold.co/100x100/e2e8f0/475569?text=${selectedJob.company.charAt(0)}` : '');
            const backButtonHtml = `<button onclick="showJobListOnMobile()" class="lg:hidden mb-4 flex items-center gap-2 text-sm font-medium text-slate-600 hover:text-slate-800"><i data-lucide="arrow-left" class="w-4 h-4"></i>Back to Job List</button>`;
            const postedDateDetails = selectedJob ? timeAgo(selectedJob.postedDate) : '';
            const closingDateDetails = selectedJob && selectedJob.closingDate ? `Closes ${selectedJob.closingDate.toDate().toLocaleDateString('en-ZA', { year: 'numeric', month: 'long', day: 'numeric' })}` : '';
            const hasApplied = state.currentUser && state.applications.find(app => app.jobId === selectedJob?.id);
            const isRecruiterOrAdmin = state.currentUser && (state.currentUser.type === 'recruiter' || state.currentUser.type === 'admin');

            const reportButtonHtml = `<div class="p-6 text-center text-xs text-slate-400">
                <a href="#" onclick="showReportJobModal('${selectedJob ? selectedJob.id : ''}')" class="inline-flex items-center hover:text-red-600 hover:underline"><i data-lucide="flag" class="w-3 h-3 mr-1"></i>Report this job</a>
            </div>`;
            const jobDetailsHtml = selectedJob ? `${window.innerWidth < 1024 ? backButtonHtml : ''}<div class="bg-white rounded-xl border border-slate-200 h-full flex flex-col job-list-container"><div class="p-6 border-b sticky top-0 bg-white"><div class="flex flex-col sm:flex-row justify-between items-start gap-4"><div class="flex items-start gap-4 flex-grow"><img src="${companyLogoUrlForDetails}" alt="${selectedJob.company} logo" class="w-16 h-16 rounded-lg object-cover flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/100x100/e2e8f0/475569?text=${selectedJob.company.charAt(0)}'"/><div><h2 class="text-xl font-bold text-slate-800">${selectedJob.title}</h2><p class="text-slate-600 font-medium mt-1">${selectedJob.company}</p><p class="text-sm text-slate-500">${selectedJob.location} &bull; <span class="text-slate-400">${postedDateDetails}</span></p><p class="text-sm font-semibold text-emerald-600 mt-1">${selectedJob.salary || 'Market Related'}</p><p class="text-sm text-red-600 font-medium mt-1">${closingDateDetails}</p><span class="mt-2 inline-block text-xs font-semibold text-indigo-700 bg-indigo-100 px-3 py-1 rounded-full">${selectedJob.type}</span></div></div><button onclick="handleApply('${selectedJob.id}')" ${(hasApplied || isRecruiterOrAdmin) ? 'disabled' : ''} class="bg-indigo-600 text-white font-medium px-6 py-2 rounded-lg shadow-sm hover:bg-indigo-700 transition-colors flex-shrink-0 w-full sm:w-auto disabled:bg-slate-400 disabled:cursor-not-allowed">${hasApplied ? 'Applied' : 'Apply Now'}</button></div></div><div class="p-6 overflow-y-auto flex-grow"><h3 class="font-semibold text-slate-800 mb-2 uppercase text-xs tracking-wider">Job Description</h3><p class="text-slate-600 whitespace-pre-wrap leading-relaxed">${selectedJob.description}</p></div>${reportButtonHtml}</div>` : `<div class="hidden lg:flex items-center justify-center h-full bg-white rounded-xl border border-slate-200 text-slate-500">Select a job to view details</div>`;

            const isMobile = window.innerWidth < 1024;
            const listClasses = isMobile && state.mobileShowDetails ? 'hidden' : 'block';
            const detailsClasses = isMobile && !state.mobileShowDetails ? 'hidden' : 'block';

            views.findJobs.innerHTML = `
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
                     <div class="bg-white p-4 rounded-xl border border-slate-200 mb-6 flex flex-col md:flex-row items-center gap-4">
                         <div class="relative flex-grow w-full"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="search" class="w-5 h-5 text-slate-400"></i></div><input type="text" placeholder="Search by skill, title or company" class="w-full pl-10 pr-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none"></div>
                         <div class="relative flex-grow w-full"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="map-pin" class="w-5 h-5 text-slate-400"></i></div><input type="text" placeholder="Location, e.g., 'Pretoria'" class="w-full pl-10 pr-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none"></div>
                        <button class="w-full md:w-auto text-white bg-indigo-600 hover:bg-indigo-700 font-medium px-6 py-2.5 rounded-lg text-sm transition-colors flex-shrink-0">Search</button>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="lg:col-span-1 ${listClasses}">
                            <h2 class="text-xl font-bold text-slate-800 mb-4">Showing ${currentJobs.length} of ${state.jobs.length} Jobs</h2>
                            <div class="space-y-3">${jobListHtml}</div>
                             ${paginationHtml}
                        </div>
                        <div class="lg:col-span-1 ${detailsClasses}">
                            ${jobDetailsHtml}
                        </div>
                    </div>
                </div>`;
            lucide.createIcons();
        }

        function renderSeekerDashboard() {
            if (!state.currentUser) return;
            const myApplications = state.applications;
            const statusCounts = myApplications.reduce((acc, app) => {
                acc[app.status] = (acc[app.status] || 0) + 1;
                return acc;
            }, { applied: 0, viewed: 0, shortlisted: 0, interview: 0, rejected: 0, hired: 0 });

            const recommendedJobs = state.jobs.slice(3,6);

            views.seekerDashboard.innerHTML = `
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
                    <div class="mb-8">
                        <h1 class="text-3xl font-bold text-slate-800">Welcome, ${state.currentUser.name}!</h1>
                        <p class="text-slate-500">Signed in as ${state.currentUser.email}</p>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-xl border border-slate-200">
                            <h3 class="text-sm font-medium text-slate-500">Applications Sent</h3>
                            <p class="text-3xl font-bold text-slate-800 mt-2">${myApplications.length}</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl border border-slate-200">
                            <h3 class="text-sm font-medium text-slate-500">Interviews Scheduled</h3>
                            <p class="text-3xl font-bold text-slate-800 mt-2">1</p> <!-- Mock -->
                        </div>
                         <div class="bg-white p-6 rounded-xl border border-slate-200">
                            <h3 class="text-sm font-medium text-slate-500">Jobs Saved</h3>
                            <p class="text-3xl font-bold text-slate-800 mt-2">${state.savedJobs.length}</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 bg-white p-6 rounded-xl border border-slate-200">
                            <h3 class="text-lg font-bold text-slate-800 mb-4">Recent Application Activity</h3>
                             <div class="space-y-4">
                                ${myApplications.slice(0,3).map(app => {
                                    const job = state.jobs.find(j => j.id === app.jobId);
                                    return job ? `<div class="flex items-center gap-4 p-3 rounded-lg hover:bg-slate-50">
                                        <div class="w-10 h-10 bg-slate-200 rounded-lg flex items-center justify-center font-bold text-slate-500">${job.company.charAt(0)}</div>
                                        <div class="flex-grow"><p class="font-semibold text-sm">Applied for ${job.title}</p><p class="text-xs text-slate-500">${job.company}</p></div>
                                        <span class="status-badge status-${app.status}">${app.status}</span>
                                    </div>` : '';
                                }).join('')}
                             </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl border border-slate-200">
                            <h3 class="text-lg font-bold text-slate-800 mb-4">Application Status</h3>
                            <canvas id="seeker-application-chart" class="max-h-60 mx-auto"></canvas>
                        </div>
                    </div>

                     <div class="mt-8 bg-white p-6 rounded-xl border border-slate-200">
                            <h3 class="text-lg font-bold text-slate-800 mb-4">Recommended For You</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                ${recommendedJobs.map(job => `
                                    <div class="p-4 rounded-lg border hover:shadow-md cursor-pointer" onclick="handleNavigate('findJobs'); selectJob('${job.id}');">
                                        <h4 class="font-bold text-slate-800">${job.title}</h4>
                                        <p class="text-sm text-slate-600">${job.company}</p>
                                        <p class="text-xs text-slate-500 mt-1">${job.location}</p>
                                    </div>
                                `).join('')}
                            </div>
                       </div>
                </div>
            `;
            
            // This needs to be delayed slightly to ensure the canvas element is in the DOM
            setTimeout(() => {
                const ctx = document.getElementById('seeker-application-chart');
                if (ctx) {
                     if(state.seekerDashboardChart) {
                         state.seekerDashboardChart.destroy();
                    }
                    state.seekerDashboardChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(statusCounts).map(s => s.charAt(0).toUpperCase() + s.slice(1)),
                            datasets: [{
                                label: 'Applications',
                                data: Object.values(statusCounts),
                                backgroundColor: ['#e0f2fe', '#dbeafe', '#d1fae5', '#e9d5ff', '#fee2e2', '#f0abfc'],
                                borderColor: ['#0284c7', '#3b82f6', '#059669', '#9333ea', '#dc2626', '#c026d3'],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { position: 'top' }
                            }
                        }
                    });
                }
            }, 0);
        }

        function renderSeekerApplications() {
            if (!state.currentUser) return;
            
            const myApplications = state.applications;

            const applicationListHtml = myApplications.length > 0 ? myApplications.map(app => {
                const job = state.jobs.find(j => j.id === app.jobId);
                return job ? `<tr class="hover:bg-slate-50">
                    <td class="p-4 font-medium text-slate-800">${job.title}</td>
                    <td class="p-4 text-slate-600">${job.company}</td>
                    <td class="p-4 text-slate-500">${app.appliedDate.toDate().toLocaleDateString('en-ZA')}</td>
                    <td class="p-4"><span class="status-badge status-${app.status}">${app.status}</span></td>
                    <td class="p-4 text-right">
                        <button onclick="showJobDetails('${job.id}')" class="text-indigo-600 hover:text-indigo-800 font-medium">View Job</button>
                    </td>
                </tr>` : '';
            }).join('') : '<tr><td colspan="5" class="text-center p-8 text-slate-500">You have not applied for any jobs yet.</td></tr>';
            
            views.seekerApplications.innerHTML = `
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
                    <h1 class="text-3xl font-bold text-slate-800 mb-8">My Applications</h1>
                    <div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left min-w-[640px]">
                                <thead class="bg-slate-50 text-xs text-slate-500 uppercase tracking-wider"><tr><th class="p-4">Job Title</th><th class="p-4">Company</th><th class="p-4">Date Applied</th><th class="p-4">Status</th><th class="p-4"></th></tr></thead>
                                <tbody>${applicationListHtml}</tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
        }

        function renderSeekerSavedJobs() {
            const savedJobObjects = state.savedJobs.map(jobId => state.jobs.find(j => j.id === jobId)).filter(Boolean);

            const savedJobsHtml = savedJobObjects.length > 0 ? savedJobObjects.map(job => {
                const postedDate = timeAgo(job.postedDate);
                 return `
                    <div class="bg-white p-6 rounded-xl border border-slate-200 flex flex-col sm:flex-row justify-between items-start gap-4">
                        <div>
                            <h3 class="font-bold text-lg text-slate-800">${job.title}</h3>
                            <p class="text-slate-600 font-medium">${job.company}</p>
                            <p class="text-sm text-slate-500 mt-1">${job.location} &bull; <span class="text-slate-400">${postedDate}</span></p>
                        </div>
                        <div class="flex items-center gap-2 flex-shrink-0 w-full sm:w-auto">
                           <button onclick="handleSaveJob('${job.id}')" class="w-full sm:w-auto text-slate-500 bg-slate-100 hover:bg-slate-200 font-medium px-4 py-2 rounded-lg text-sm transition-colors flex items-center justify-center gap-2"><i data-lucide="trash-2" class="w-4 h-4"></i>Unsave</button>
                           <button onclick="handleNavigate('findJobs'); selectJob('${job.id}');" class="w-full sm:w-auto text-white bg-indigo-600 hover:bg-indigo-700 font-medium px-4 py-2 rounded-lg text-sm transition-colors flex items-center justify-center gap-2"><i data-lucide="eye" class="w-4 h-4"></i>View</button>
                        </div>
                    </div>
                `
            }).join('') : `<p class="text-slate-500">You haven't saved any jobs yet.</p>`;

            views.seekerSavedJobs.innerHTML = `
                 <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
                    <h1 class="text-3xl font-bold text-slate-800 mb-8">Saved Jobs</h1>
                    <div class="space-y-4">
                        ${savedJobsHtml}
                    </div>
                </div>
            `;
            lucide.createIcons();
        }
        
        function changeRecruiterPage(page) {
            state.recruiterJobsCurrentPage = page;
            renderRecruiterJobsPage();
        }
        
        function renderRecruiterJobsPage() {
            if (!state.currentUser) return;

            const recruiterJobs = state.jobs.filter(job => job.recruiterId === state.currentUser.uid);
            // Pagination logic for recruiter jobs
            const indexOfLastJob = state.recruiterJobsCurrentPage * state.recruiterJobsPerPage;
            const indexOfFirstJob = indexOfLastJob - state.recruiterJobsPerPage;
            const currentJobs = recruiterJobs.slice(indexOfFirstJob, indexOfLastJob);
            const totalPages = Math.ceil(recruiterJobs.length / state.recruiterJobsPerPage);

            const jobListingsHtml = currentJobs.length > 0 ? currentJobs.map(job => {
                const postedDate = timeAgo(job.postedDate);
                const applicantCount = state.applications.filter(app => app.jobId === job.id).length;
                const isSelected = job.id === state.selectedRecruiterJobId;
                return `
                <div id="recruiter-job-${job.id}" class="bg-white p-6 rounded-xl border-2 ${isSelected ? 'border-indigo-500 shadow-md' : 'border-slate-200'}">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-bold text-lg text-slate-800">${job.title}</h3>
                            <p class="text-slate-600 font-medium">${job.company}</p>
                            <p class="text-sm text-slate-500 mt-1">${job.location} &bull; <span class="text-slate-400">${postedDate}</span></p>
                             <p class="text-sm font-semibold text-emerald-600 mt-1">${job.salary || 'Market Related'}</p>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-slate-800">${applicantCount}</div>
                            <div class="text-sm text-slate-500">Applicants</div>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-slate-200 flex justify-end gap-2">
                        <button onclick="showEditJobModal('${job.id}')" class="text-slate-500 bg-slate-100 hover:bg-slate-200 font-medium px-4 py-2 rounded-lg text-sm transition-colors">Edit</button>
                        <button onclick="showApplicantsModal('${job.id}')" class="text-white bg-indigo-600 hover:bg-indigo-700 font-medium px-4 py-2 rounded-lg text-sm transition-colors">View Applicants</button>
                         <button onclick="showDeleteConfirmation('${job.id}')" class="text-white bg-red-600 hover:bg-red-700 font-medium px-4 py-2 rounded-lg text-sm transition-colors">Delete</button>
                    </div>
                </div>`;
            }).join('')
                 : '<p class="text-slate-500 md:col-span-2">You haven\'t posted any jobs yet. Click "Post New Job" to get started.</p>';

            // Pagination controls
            let paginationHtml = '';
            if (totalPages > 1) {
                paginationHtml += '<div class="flex justify-center items-center gap-2 mt-8">';
                paginationHtml += `<button onclick="changeRecruiterPage(${state.recruiterJobsCurrentPage - 1})" ${state.recruiterJobsCurrentPage === 1 ? 'disabled' : ''} class="px-3 py-1 rounded-md bg-white border border-slate-300 text-sm font-medium text-slate-600 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">&laquo; Prev</button>`;
                for (let i = 1; i <= totalPages; i++) {
                    paginationHtml += `<button onclick="changeRecruiterPage(${i})" class="px-3 py-1 rounded-md border text-sm font-medium ${state.recruiterJobsCurrentPage === i ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-slate-600 border-slate-300 hover:bg-slate-50'}">${i}</button>`;
                }
                paginationHtml += `<button onclick="changeRecruiterPage(${state.recruiterJobsCurrentPage + 1})" ${state.recruiterJobsCurrentPage === totalPages ? 'disabled' : ''} class="px-3 py-1 rounded-md bg-white border border-slate-300 text-sm font-medium text-slate-600 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">Next &raquo;</button></div>`;
            }

            views.recruiterJobs.innerHTML = `
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12"><div class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4"><h1 class="text-3xl font-bold text-slate-800">Your Job Postings</h1><button onclick="showPostJobModal()" class="bg-indigo-600 text-white font-medium px-5 py-2.5 rounded-lg shadow-sm hover:bg-indigo-700 transition-colors flex items-center gap-2 w-full sm:w-auto justify-center"><i data-lucide="plus-circle" class="w-5 h-5"></i>Post New Job</button></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">${jobListingsHtml}</div>
                ${paginationHtml}
                </div>`;
            lucide.createIcons();
            if (state.selectedRecruiterJobId) {
                const el = document.getElementById(`recruiter-job-${state.selectedRecruiterJobId}`);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                state.selectedRecruiterJobId = null; // Reset after use
            }
        }

        function renderRecruiterPipelinePage() {
            if (!state.currentUser || state.currentUser.type !== 'recruiter') return;

            const recruiterJobs = state.jobs.filter(job => job.recruiterId === state.currentUser.uid);
            const recruiterJobIds = recruiterJobs.map(j => j.id);

            let filteredApplications = state.applications.filter(app => recruiterJobIds.includes(app.jobId));
            
            if (state.pipelineSelectedJobId !== 'all') {
                filteredApplications = filteredApplications.filter(app => app.jobId === state.pipelineSelectedJobId);
            }

            const pipelineColumns = {
                applied: [],
                viewed: [],
                shortlisted: [],
                interview: [],
                hired: [],
            };

            filteredApplications.forEach(app => {
                const candidate = state.candidates.find(c => c.id === app.candidateId);
                const user = state.allUsers[app.candidateId]; // Fallback for name/email
                if (candidate || user) {
                    const applicantData = { 
                        ...app,
                        name: candidate?.name || user?.name,
                        photoURL: candidate?.photoURL || user?.photoURL,
                        initials: (candidate?.name || user?.name || '?').split(' ').map(n=>n[0]).join('')
                    };
                    if (pipelineColumns[app.status]) {
                        pipelineColumns[app.status].push(applicantData);
                    }
                }
            });

            const jobOptionsHtml = recruiterJobs.map(job => `<option value="${job.id}" ${state.pipelineSelectedJobId === job.id ? 'selected' : ''}>${job.title}</option>`).join('');

            const renderColumn = (title, applicants) => `
                <div class="kanban-column bg-slate-100 rounded-xl p-4">
                    <h3 class="font-semibold text-slate-700 mb-4 uppercase text-sm tracking-wider">${title} (${applicants.length})</h3>
                    <div class="kanban-cards space-y-4" data-status="${title.toLowerCase()}" ondragover="handleDragOver(event)" ondrop="handleDrop(event)" ondragenter="handleDragEnter(event)" ondragleave="handleDragLeave(event)">
                        ${applicants.map(app => `
                            <div class="kanban-card bg-white p-4 rounded-lg border border-slate-200 shadow-sm" draggable="true" data-application-id="${app.id}" ondragstart="handleDragStart(event)">
                                <p class="font-semibold text-slate-800">${app.name}</p>
                                <button onclick="showCandidateDetails('${app.candidateId}')" class="text-xs text-indigo-600 hover:underline mt-1">View Profile</button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            views.recruiterPipeline.innerHTML = `
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
                     <div class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
                         <h1 class="text-3xl font-bold text-slate-800">Applicant Pipeline</h1>
                         <div class="w-full sm:w-64">
                             <select id="pipeline-job-filter" class="w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                 <option value="all" ${state.pipelineSelectedJobId === 'all' ? 'selected' : ''}>All Jobs</option>
                                 ${jobOptionsHtml}
                             </select>
                         </div>
                     </div>
                     <div class="kanban-board">
                        ${renderColumn('Applied', pipelineColumns.applied)}
                        ${renderColumn('Viewed', pipelineColumns.viewed)}
                        ${renderColumn('Shortlisted', pipelineColumns.shortlisted)}
                        ${renderColumn('Interview', pipelineColumns.interview)}
                        ${renderColumn('Hired', pipelineColumns.hired)}
                     </div>
                </div>
            `;

            document.getElementById('pipeline-job-filter').addEventListener('change', (e) => {
                state.pipelineSelectedJobId = e.target.value;
                renderRecruiterPipelinePage();
            });
        }

        function renderRecruiterDashboard() {
             if (!state.currentUser) return;
             const recruiterJobs = state.jobs.filter(job => job.recruiterId === state.currentUser.uid);
             const recruiterJobIds = recruiterJobs.map(j => j.id);
             
             const recruiterApplications = state.applications.filter(app => recruiterJobIds.includes(app.jobId));
             const now = getSimulatedNow();
             const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
             
             const newApplicants = recruiterApplications.filter(app => app.appliedDate.toDate() > sevenDaysAgo).length;
             
             const jobsClosingSoon = recruiterJobs
                .filter(job => job.closingDate && job.closingDate.toDate() > now)
                .sort((a,b) => a.closingDate.toDate() - b.closingDate.toDate())
                .slice(0, 3);
            
            const recentApplications = state.applications
                .filter(app => recruiterJobIds.includes(app.jobId))
                .sort((a, b) => b.appliedDate.toDate() - a.appliedDate.toDate())
                .slice(0, 3);

            const recentApplicantsDetails = recentApplications.map(app => {
                const candidate = state.candidates.find(c => c.id === app.candidateId);
                const job = state.jobs.find(j => j.id === app.jobId);
                return { candidate, job };
            }).filter(item => item.candidate && item.job);

            views.recruiterDashboard.innerHTML = `
                 <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
                     <div class="mb-8">
                         <h1 class="text-3xl font-bold text-slate-800">Recruiter Dashboard</h1>
                         <p class="text-slate-500">For ${state.currentUser.name} (${state.currentUser.email})</p>
                     </div>
                     
                     <!-- Stat Cards -->
                     <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                         <div class="bg-white p-6 rounded-xl border border-slate-200">
                             <h3 class="text-sm font-medium text-slate-500">Active Jobs</h3>
                             <p class="text-3xl font-bold text-slate-800 mt-2">${recruiterJobs.length}</p>
                         </div>
                         <div class="bg-white p-6 rounded-xl border border-slate-200">
                             <h3 class="text-sm font-medium text-slate-500">Total Applicants</h3>
                             <p class="text-3xl font-bold text-slate-800 mt-2">${recruiterApplications.length}</p>
                         </div>
                         <div class="bg-white p-6 rounded-xl border border-slate-200">
                             <h3 class="text-sm font-medium text-slate-500">New Applicants (7 days)</h3>
                             <p class="text-3xl font-bold text-slate-800 mt-2">${newApplicants}</p>
                         </div>
                     </div>

                     <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                         <!-- Application Trends -->
                         <div class="lg:col-span-2 bg-white p-6 rounded-xl border border-slate-200">
                              <h3 class="text-lg font-bold text-slate-800 mb-4">Application Trends (Last 7 Days)</h3>
                              <canvas id="application-chart"></canvas>
                         </div>
                         
                         <!-- Recent Applicants -->
                         <div class="bg-white rounded-xl border border-slate-200">
                             <h3 class="text-lg font-bold text-slate-800 p-6 border-b">Recent Applicants</h3>
                             <div class="p-6 space-y-4">
                                 ${recentApplicantsDetails.length > 0 ? recentApplicantsDetails.map(({candidate, job}) => `
                                     <div class="flex items-center gap-4">
                                         <div class="w-10 h-10 rounded-full bg-slate-200 flex-shrink-0 flex items-center justify-center font-bold text-slate-500">${candidate.name.charAt(0)}</div>
                                         <div><p class="font-semibold text-sm">${candidate.name}</p><p class="text-xs text-slate-500">Applied for ${job.title}</p></div>
                                     </div>
                                 `).join('') : '<p class="text-sm text-slate-500">No recent applicants.</p>' }
                             </div>
                         </div>
                     </div>
                      <!-- Jobs Closing Soon -->
                       <div class="mt-8 bg-white p-6 rounded-xl border border-slate-200">
                           <h3 class="text-lg font-bold text-slate-800 mb-4">Jobs Nearing Closing Date</h3>
                           <div class="space-y-2">
                           ${jobsClosingSoon.length > 0 ? jobsClosingSoon.map(job => {
                               const daysLeft = Math.ceil((job.closingDate.toDate() - now) / (1000 * 60 * 60 * 24));
                               return `<div onclick="selectRecruiterJobAndNavigate('${job.id}')" class="flex justify-between items-center p-3 -m-3 rounded-lg cursor-pointer hover:bg-slate-50">
                                   <p class="font-medium text-slate-800">${job.title}</p>
                                   <p class="text-sm text-red-600">${daysLeft} day${daysLeft > 1 ? 's' : ''} left</p>
                               </div>`;
                           }).join('') : '<p class="text-slate-500 text-sm">No jobs are closing soon.</p>'}
                           </div>
                       </div>
                 </div>
            `;

            // Chart rendering
            setTimeout(() => {
                const ctx = document.getElementById('application-chart');
                if (ctx) {
                    if(state.recruiterDashboardChart) {
                         state.recruiterDashboardChart.destroy();
                    }
                    const nowForChart = getSimulatedNow();
                    const labels = Array(7).fill(0).map((_, i) => {
                        const d = new Date(nowForChart.getTime() - (6-i) * 24 * 60 * 60 * 1000);
                        return d.toLocaleDateString('en-ZA', { weekday: 'short' });
                    });
                     const applicationCounts = labels.map((label, i) => {
                         const dayStart = new Date(nowForChart.getTime() - (6-i) * 24 * 60 * 60 * 1000);
                         dayStart.setHours(0,0,0,0);
                         const dayEnd = new Date(dayStart.getTime() + 24 * 60 * 60 * 1000);

                         return recruiterApplications.filter(app => {
                             const appDate = app.appliedDate.toDate();
                             return appDate >= dayStart && appDate < dayEnd;
                         }).length;
                    });
                    state.recruiterDashboardChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Applications',
                                data: applicationCounts,
                                backgroundColor: 'rgba(79, 70, 229, 0.7)',
                                borderColor: 'rgba(79, 70, 229, 1)',
                                borderWidth: 1,
                                borderRadius: 4,
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
                            plugins: { legend: { display: false } }
                        }
                    });
                }
            }, 0);
        }
        
        // --- DRAG AND DROP FOR KANBAN ---
        function handleDragStart(event) {
            event.dataTransfer.setData("text/plain", event.target.dataset.applicationId);
            setTimeout(() => {
                event.target.classList.add('dragging');
            }, 0);
        }

        function handleDragOver(event) {
            event.preventDefault();
        }

        function handleDragEnter(event) {
            event.preventDefault();
            const column = event.target.closest('.kanban-cards');
            if (column) {
                column.parentElement.classList.add('drag-over');
            }
        }

        function handleDragLeave(event) {
            const column = event.target.closest('.kanban-cards');
            if (column) {
                 column.parentElement.classList.remove('drag-over');
            }
        }

        async function handleDrop(event) {
            event.preventDefault();
            const column = event.target.closest('.kanban-cards');
            if (!column) return;

            column.parentElement.classList.remove('drag-over');
            const applicationId = event.dataTransfer.getData("text/plain");
            const newStatus = column.dataset.status;

            const application = state.applications.find(app => app.id === applicationId);
            if (application && application.status !== newStatus) {
                try {
                    const appDocRef = doc(db, "applications", applicationId);
                    await updateDoc(appDocRef, { status: newStatus });
                    
                    // Create notification for the job seeker
                    const applicant = state.candidates.find(c => c.id === application.candidateId);
                    const job = state.jobs.find(j => j.id === application.jobId);
                    if (applicant && job) {
                        const message = `Your application for ${job.title} was updated to: ${newStatus}.`;
                        await createNotification(applicant.id, message, 'seekerApplications', job.id);
                    }
                } catch (error) {
                    console.error("Error updating application status: ", error);
                    showConfirmationModal("Update Failed", "Could not update applicant status. Please try again.", () => closeModal('confirmation-modal'), false, true, false);
                }
            }

            const draggedEl = document.querySelector(`[data-application-id="${applicationId}"]`);
            if (draggedEl) {
                draggedEl.classList.remove('dragging');
                // The onSnapshot will handle re-rendering, but for immediate feedback:
                column.appendChild(draggedEl);
            }
        }

        function renderCvDatabasePage() {
            const searchTerm = state.cvSearchTerm.toLowerCase();
            const { experience, location, jobType, skills } = state.cvFilters;
            
            let filteredCandidates = state.candidates.filter(candidate => {
                const nameMatch = candidate.name.toLowerCase().includes(searchTerm);
                const generalSkillsMatch = (candidate.skills || '').toLowerCase().includes(searchTerm);
                
                const experienceMatch = experience === 'any' || parseInt(candidate.experience) >= parseInt(experience);
                
                const locationMatch = !location || (candidate.location && candidate.location.toLowerCase().includes(location.toLowerCase()));

                const jobTypeMatch = jobType.length === 0 || jobType.includes(candidate.jobType);

                const specificSkills = skills.split(',').map(s => s.trim().toLowerCase()).filter(s => s);
                const specificSkillsMatch = specificSkills.length === 0 || specificSkills.every(skill => (candidate.skills || '').toLowerCase().includes(skill));

                return (nameMatch || generalSkillsMatch) && experienceMatch && locationMatch && jobTypeMatch && specificSkillsMatch;
            });
            
            const candidatesHtml = filteredCandidates.map(candidate => `
            <div class="bg-white p-6 rounded-xl border border-slate-200 flex flex-col">
                <div>
                    <h3 class="font-bold text-lg text-slate-800">${candidate.name}</h3>
                    <p class="text-sm text-slate-500 mt-1">${candidate.experience || '0'} years of experience</p>
                    <p class="text-sm text-slate-500 mt-1">${candidate.location || 'Not specified'}</p>
                    <span class="mt-2 inline-block text-xs font-semibold text-indigo-700 bg-indigo-100 px-3 py-1 rounded-full">${candidate.jobType || 'Full-time'}</span>
                </div>
                <div class="flex-grow mt-4">
                    <div class="flex flex-wrap gap-2">
                        ${(candidate.skills || '').split(', ').filter(s => s).map(skill => `<span class="bg-slate-100 text-slate-600 text-xs font-medium px-2 py-1 rounded-md">${skill}</span>`).join('')}
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-slate-200 flex justify-end">
                    <button onclick="showCandidateDetails('${candidate.id}')" class="text-white bg-indigo-600 hover:bg-indigo-700 font-medium px-4 py-2 rounded-lg text-sm transition-colors">View Profile</button>
                </div>
            </div>`).join('');
            
            views.cvDatabase.innerHTML = `
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
                <h1 class="text-3xl font-bold text-slate-800 mb-2">CV Database</h1>
                <p class="text-slate-600 mb-8">Search and discover talented candidates.</p>
                <div class="bg-white p-4 rounded-xl border border-slate-200 mb-8 flex items-center gap-4">
                    <div class="relative flex-grow">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="search" class="w-5 h-5 text-slate-400"></i></div>
                        <input type="text" id="cv-search-input" value="${state.cvSearchTerm}" placeholder="Search by name or skill, e.g., 'React'" class="w-full pl-10 pr-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
                    </div>
                    <button onclick="showCvFilterModal()" class="text-slate-500 bg-slate-100 hover:bg-slate-200 font-medium px-4 py-2.5 rounded-lg text-sm transition-colors flex items-center gap-2">
                        <i data-lucide="sliders-horizontal" class="w-4 h-4"></i>
                        Filters
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${filteredCandidates.length > 0 ? candidatesHtml : '<p class="text-slate-500 md:col-span-3">No candidates match your search criteria.</p>'}
                </div>
            </div>`;

            const searchInput = document.getElementById('cv-search-input');
            searchInput.addEventListener('input', (e) => {
                state.cvSearchTerm = e.target.value;
                renderCvDatabasePage();
            });

            lucide.createIcons();
        }

        function renderSubscriptionPage() {
            views.subscription.innerHTML = `<div class="bg-white"><div class="container mx-auto px-4 sm:px-6 lg:px-8 py-16 text-center"><h1 class="text-4xl sm:text-5xl font-extrabold text-slate-900 tracking-tight">Choose Your Plan</h1><p class="mt-4 max-w-2xl mx-auto text-lg text-slate-600">Simple, transparent pricing to help you find the best talent.</p></div></div><div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12"><div class="max-w-4xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8"><div class="bg-white rounded-xl border border-slate-200 p-8 flex flex-col"><h3 class="text-lg font-semibold text-slate-800">Basic</h3><p class="mt-4 text-4xl font-bold text-slate-900">R499 <span class="text-xl font-medium text-slate-500">/ month</span></p><ul class="mt-6 space-y-4 text-slate-600"><li class="flex items-center gap-3"><i data-lucide="check" class="w-5 h-5 text-emerald-500"></i>5 job posts / month</li><li class="flex items-center gap-3"><i data-lucide="check" class="w-5 h-5 text-emerald-500"></i>50 CV views / month</li><li class="flex items-center gap-3"><i data-lucide="check" class="w-5 h-5 text-emerald-500"></i>Basic analytics</li></ul><button class="mt-auto w-full bg-indigo-100 text-indigo-700 font-semibold py-3 px-4 rounded-lg hover:bg-indigo-200 transition-colors">Choose Basic</button></div><div class="bg-white rounded-xl border-2 border-indigo-600 p-8 flex flex-col relative"><div class="absolute top-0 -translate-y-1/2 left-1/2 -translate-x-1/2"><span class="bg-indigo-600 text-white text-xs font-bold uppercase tracking-wider px-3 py-1 rounded-full">Most Popular</span></div><h3 class="text-lg font-semibold text-slate-800">Pro</h3><p class="mt-4 text-4xl font-bold text-slate-900">R1,499 <span class="text-xl font-medium text-slate-500">/ month</span></p><ul class="mt-6 space-y-4 text-slate-600"><li class="flex items-center gap-3"><i data-lucide="check" class="w-5 h-5 text-emerald-500"></i>20 job posts / month</li><li class="flex items-center gap-3"><i data-lucide="check" class="w-5 h-5 text-emerald-500"></i>500 CV views / month</li><li class="flex items-center gap-3"><i data-lucide="check" class="w-5 h-5 text-emerald-500"></i>Advanced analytics</li><li class="flex items-center gap-3"><i data-lucide="check" class="w-5 h-5 text-emerald-500"></i>Email support</li></ul><button class="mt-auto w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors shadow-sm">Choose Pro</button></div><div class="bg-white rounded-xl border border-slate-200 p-8 flex flex-col"><h3 class="text-lg font-semibold text-slate-800">Enterprise</h3><p class="mt-4 text-4xl font-bold text-slate-900">Contact Us</p><ul class="mt-6 space-y-4 text-slate-600"><li class="flex items-center gap-3"><i data-lucide="check" class="w-5 h-5 text-emerald-500"></i>Unlimited job posts</li><li class="flex items-center gap-3"><i data-lucide="check" class="w-5 h-5 text-emerald-500"></i>Unlimited CV views</li><li class="flex items-center gap-3"><i data-lucide="check" class="w-5 h-5 text-emerald-500"></i>Team collaboration</li><li class="flex items-center gap-3"><i data-lucide="check" class="w-5 h-5 text-emerald-500"></i>Dedicated support</li></ul><button class="mt-auto w-full bg-indigo-100 text-indigo-700 font-semibold py-3 px-4 rounded-lg hover:bg-indigo-200 transition-colors">Contact Sales</button></div></div></div>`;
            lucide.createIcons();
        }

        function handleSettingsTab(tab) {
            state.settingsActiveTab = tab;
            state.selectedCvFile = null; // Reset selected file on tab change
            renderSettingsPage();
        }

        function renderSettingsPage() {
            if (!state.currentUser) return;

            const isSeeker = state.currentUser.type === 'seeker';
            let tabs = [];
            if (isSeeker) {
                tabs = [
                    { key: 'profile', label: 'Public Profile', icon: 'user' },
                    { key: 'account', label: 'Account Settings', icon: 'settings' },
                    { key: 'notifications', label: 'Notifications', icon: 'bell' },
                ];
            } else { // Recruiter or Admin
                 tabs = [
                    { key: 'companyProfile', label: 'Company Profile', icon: 'building-2' },
                    { key: 'account', label: 'Account Settings', icon: 'settings' },
                    { key: 'team', label: 'Team Members', icon: 'users' },
                    { key: 'billing', label: 'Billing', icon: 'credit-card' },
                ];
            }

            const sidebarHtml = tabs.map(tab => {
                const isActive = state.settingsActiveTab === tab.key;
                return `<a href="#" onclick="handleSettingsTab('${tab.key}')" class="flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium ${isActive ? 'bg-indigo-100 text-indigo-700' : 'text-slate-600 hover:bg-slate-100 hover:text-slate-900'}"><i data-lucide="${tab.icon}" class="w-5 h-5"></i><span>${tab.label}</span></a>`;
            }).join('');
            
            // For mobile view
            const selectOptionsHtml = tabs.map(tab => `<option value="${tab.key}" ${state.settingsActiveTab === tab.key ? 'selected' : ''}>${tab.label}</option>`).join('');

            let contentHtml = '';
            const userProfile = state.candidates.find(c => c.id === state.currentUser.uid) || {};

            switch (state.settingsActiveTab) {
                case 'profile':
                    contentHtml = `
                    <form id="profile-form">
                        <h2 class="text-2xl font-bold text-slate-800">Public Profile</h2>
                        <p class="text-slate-500 mt-1 mb-6">This information will be displayed on your public profile.</p>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-700">Profile Photo</label>
                                <div class="mt-1 flex items-center gap-4">
                                    <img id="profile-photo-preview" src="${userProfile.photoURL || `https://placehold.co/100x100/6366f1/ffffff?text=${state.currentUser.initials}`}" class="h-20 w-20 rounded-full object-cover" alt="Profile photo preview">
                                    <label for="photo-upload" class="cursor-pointer bg-white py-2 px-3 border border-gray-300 rounded-md shadow-sm text-sm leading-4 font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                        <span>Change</span>
                                        <input id="photo-upload" name="photo" type="file" class="sr-only" accept="image/*" onchange="handlePhotoFileSelect(event, 'profile-photo-preview')">
                                    </label>
                                </div>
                            </div>
                             <div>
                                <label class="block text-sm font-medium text-slate-700">Full Name</label>
                                <input name="name" type="text" value="${userProfile.name || ''}" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700">Email Address</label>
                                <input type="email" value="${state.currentUser.email || ''}" disabled class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm bg-slate-50 text-slate-500 cursor-not-allowed">
                            </div>
                            <div><label class="block text-sm font-medium text-slate-700">Location</label><input name="location" type="text" value="${userProfile.location || ''}" placeholder="e.g. Pretoria, Gauteng" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                            <div><label class="block text-sm font-medium text-slate-700">Phone Number</label><input name="phone" type="tel" value="${userProfile.phone || ''}" placeholder="e.g., 082 123 4567" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700">LinkedIn Profile URL</label>
                                <input name="linkedin" type="url" value="${userProfile.linkedin || ''}" placeholder="https://linkedin.com/in/your-profile" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                ${userProfile.linkedin ? `<a href="${userProfile.linkedin}" target="_blank" class="mt-2 text-sm text-indigo-600 hover:text-indigo-800 flex items-center gap-1"><i data-lucide="link" class="w-4 h-4"></i>View LinkedIn Profile</a>` : ''}
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700">Portfolio / GitHub URL</label>
                                <input name="github" type="url" value="${userProfile.github || ''}" placeholder="https://github.com/your-username" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                ${userProfile.github ? `<a href="${userProfile.github}" target="_blank" class="mt-2 text-sm text-indigo-600 hover:text-indigo-800 flex items-center gap-1"><i data-lucide="link" class="w-4 h-4"></i>View GitHub Profile</a>` : ''}
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700">Experience (years)</label>
                                    <input name="experience" type="number" value="${userProfile.experience || '0'}" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700">Preferred Job Type</label>
                                    <select name="jobType" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                        <option ${userProfile.jobType === 'Full-time' ? 'selected' : ''}>Full-time</option>
                                        <option ${userProfile.jobType === 'Part-time' ? 'selected' : ''}>Part-time</option>
                                        <option ${userProfile.jobType === 'Contract' ? 'selected' : ''}>Contract</option>
                                        <option ${userProfile.jobType === 'Internship' ? 'selected' : ''}>Internship</option>
                                        <option ${userProfile.jobType === 'Hybrid' ? 'selected' : ''}>Hybrid</option>
                                        <option ${userProfile.jobType === 'Remote' ? 'selected' : ''}>Remote</option>
                                    </select>
                                </div>
                            </div>
                            <div><label class="block text-sm font-medium text-slate-700">Skills</label><input name="skills" type="text" value="${userProfile.skills || ''}" placeholder="e.g. React, Node.js, Python" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                            <div><label class="block text-sm font-medium text-slate-700">Professional Summary</label><textarea name="summary" rows="4" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">${userProfile.summary || ''}</textarea></div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700">My CV</label>
                                <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-slate-300 border-dashed rounded-md">
                                    <div class="space-y-1 text-center">
                                        <i data-lucide="file-text" class="mx-auto h-12 w-12 text-slate-400"></i>
                                        <div id="cv-file-info" class="flex text-sm text-slate-600 justify-center">
                                            <label for="cv-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500">
                                                <span id="cv-upload-text">${userProfile.cvFileName ? 'Replace file' : 'Upload a file'}</span>
                                                <input id="cv-upload" name="cv" type="file" class="sr-only" onchange="handleCvFileSelect(event)">
                                            </label>
                                            <p class="pl-1">or drag and drop</p>
                                        </div>
                                        <p class="text-xs text-slate-500">PDF up to 10MB</p>
                                        <p id="cv-file-name" class="text-sm font-medium text-slate-700 pt-2">${userProfile.cvFileName ? `Current: ${userProfile.cvFileName}` : ''}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                    `;
                    break;
                case 'companyProfile':
                    const companyProfile = state.allUsers[state.currentUser.uid] || {};
                    contentHtml = `
                        <h2 class="text-2xl font-bold text-slate-800">Company Profile</h2>
                        <p class="text-slate-500 mt-1 mb-6">This information will be displayed on your company page and job posts.</p>
                        <form id="company-profile-form">
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700">Company Logo</label>
                                    <div class="mt-1 flex items-center gap-4">
                                        <img id="company-logo-preview" src="${companyProfile.photoURL || `https://placehold.co/100x100/6366f1/ffffff?text=${state.currentUser.initials}`}" class="h-20 w-20 rounded-lg object-cover" alt="Company logo preview">
                                        <label for="photo-upload" class="cursor-pointer bg-white py-2 px-3 border border-gray-300 rounded-md shadow-sm text-sm leading-4 font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                            <span>Change</span>
                                            <input id="photo-upload" name="photo" type="file" class="sr-only" accept="image/*" onchange="handlePhotoFileSelect(event, 'company-logo-preview')">
                                        </label>
                                    </div>
                                </div>
                                <div><label class="block text-sm font-medium text-slate-700">Company Name</label><input name="name" type="text" value="${state.currentUser.name}" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                                <div><label class="block text-sm font-medium text-slate-700">Company Phone</label><input name="phone" type="tel" value="${companyProfile.phone || ''}" placeholder="e.g., 011 456 7890" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                                <div><label class="block text-sm font-medium text-slate-700">Company LinkedIn</label><input name="linkedin" type="url" value="${companyProfile.linkedin || ''}" placeholder="https://linkedin.com/company/your-company" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                                <div><label class="block text-sm font-medium text-slate-700">Website</label><input name="website" type="url" value="${companyProfile.website || ''}" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                                <div><label class="block text-sm font-medium text-slate-700">Company Description</label><textarea name="description" rows="4" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">${companyProfile.description || ''}</textarea></div>
                            </div>
                        </form>
                    `;
                    break;
                case 'account':
                    contentHtml = `
                        <h2 class="text-2xl font-bold text-slate-800">Account Settings</h2>
                        <p class="text-slate-500 mt-1 mb-6">Manage your email and password.</p>
                        <div class="space-y-6">
                            <div><label class="block text-sm font-medium text-slate-700">Email Address</label><input type="email" value="${state.currentUser.email}" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                            <div class="pt-6 border-t">
                                <h3 class="text-lg font-medium text-slate-800">Change Password</h3>
                                <div class="mt-4 space-y-4">
                                     <div>
                                        <label class="block text-sm font-medium text-slate-700">Current Password</label>
                                        <div class="relative mt-1">
                                            <input id="current-password" type="password" class="block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                            <button type="button" onclick="togglePasswordVisibility('current-password', this)" class="absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5">
                                                <i data-lucide="eye" class="h-5 w-5 text-gray-400"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700">New Password</label>
                                        <div class="relative mt-1">
                                            <input id="new-password" type="password" class="block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                            <button type="button" onclick="togglePasswordVisibility('new-password', this)" class="absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5">
                                                <i data-lucide="eye" class="h-5 w-5 text-gray-400"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                 case 'notifications':
                    contentHtml = `
                        <h2 class="text-2xl font-bold text-slate-800">Notifications</h2>
                        <p class="text-slate-500 mt-1 mb-6">Manage how you receive notifications from us.</p>
                        <div class="space-y-6 divide-y">
                            <div class="flex items-center justify-between pt-6">
                                <div><h3 class="text-base font-medium text-slate-800">New Job Alerts</h3><p class="text-sm text-slate-500">Receive an email when a new job matches your criteria.</p></div>
                                <button type="button" class="bg-indigo-600 relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" role="switch" aria-checked="true"><span class="translate-x-5 pointer-events-none relative inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span></button>
                            </div>
                             <div class="flex items-center justify-between pt-6">
                                <div><h3 class="text-base font-medium text-slate-800">Application Status Updates</h3><p class="text-sm text-slate-500">Get notified when a recruiter views or updates your application.</p></div>
                                <button type="button" class="bg-indigo-600 relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" role="switch" aria-checked="true"><span class="translate-x-5 pointer-events-none relative inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span></button>
                            </div>
                        </div>
                    `;
                    break;
                case 'team':
                     contentHtml = `
                        <div class="flex items-center justify-between"><h2 class="text-2xl font-bold text-slate-800">Team Members</h2><button class="bg-indigo-600 text-white font-medium px-4 py-2 rounded-lg shadow-sm hover:bg-indigo-700 transition-colors flex items-center gap-2 text-sm"><i data-lucide="plus" class="w-4 h-4"></i>Invite Member</button></div>
                        <p class="text-slate-500 mt-1 mb-6">Manage who has access to your company account.</p>
                        <ul class="divide-y">
                           <li class="py-4 flex items-center justify-between"><div class="font-medium">${state.currentUser.email}</div><span class="text-sm text-slate-500">Admin</span></li>
                           <li class="py-4 flex items-center justify-between"><div class="font-medium">recruiter@innovateinc.co.za</div><button class="text-sm text-red-600 hover:text-red-800">Remove</button></li>
                        </ul>
                    `;
                    break;
                case 'billing':
                     contentHtml = `
                        <h2 class="text-2xl font-bold text-slate-800">Billing</h2>
                        <p class="text-slate-500 mt-1 mb-6">Manage your subscription and view payment history.</p>
                        <div class="bg-indigo-50 border-l-4 border-indigo-400 p-4 rounded-md mb-6">
                            <p class="font-medium text-indigo-800">You are currently on the Pro Plan. Your next bill is on 1 November 2025.</p>
                        </div>
                        <h3 class="text-lg font-medium text-slate-800 mb-4">Payment History</h3>
                        <div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-50 text-xs text-slate-500 uppercase"><tr><th class="p-3 text-left">Date</th><th class="p-3 text-left">Amount</th><th class="p-3 text-right"></th></tr></thead>
                                <tbody><tr class="border-t"><td class="p-3">1 Oct 2025</td><td class="p-3">R1,499.00</td><td class="p-3 text-right"><a href="#" class="font-medium text-indigo-600">Download</a></td></tr><tr class="border-t"><td class="p-3">1 Sep 2025</td><td class="p-3">R1,499.00</td><td class="p-3 text-right"><a href="#" class="font-medium text-indigo-600">Download</a></td></tr></tbody>
                            </table>
                        </div>
                    `;
                    break;
            }
            
            views.settings.innerHTML = `
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
                    <h1 class="text-3xl font-bold text-slate-800 mb-8">Settings</h1>
                    <div class="lg:grid lg:grid-cols-12 lg:gap-8">
                        <aside class="lg:col-span-3">
                            <nav class="hidden lg:block space-y-1">${sidebarHtml}</nav>
                            <div class="lg:hidden mb-4">
                                <select onchange="handleSettingsTab(this.value)" class="w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                    ${selectOptionsHtml}
                                </select>
                            </div>
                        </aside>
                        <div class="lg:col-span-9">
                            <div class="bg-white rounded-xl border border-slate-200 p-8">
                                ${contentHtml}
                                <div class="mt-8 pt-6 border-t flex justify-end">
                                    <button id="save-settings-btn" class="bg-indigo-600 text-white font-medium px-5 py-2.5 rounded-lg shadow-sm hover:bg-indigo-700 transition-colors">Save Changes</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();

            const saveBtn = document.getElementById('save-settings-btn');
            if (saveBtn) {
                 if (state.settingsActiveTab === 'profile') {
                    saveBtn.onclick = handleUpdateProfile;
                } else if (state.settingsActiveTab === 'companyProfile') {
                    saveBtn.onclick = handleUpdateCompanyProfile;
                }
            }
        }

        // --- ADMIN DASHBOARD ---
        function handleAdminTab(tab) {
            state.adminActiveTab = tab;
            renderAdminDashboard();
        }

        function renderAdminDashboard() {
            if (!state.currentUser || state.currentUser.type !== 'admin') {
                views.adminDashboard.innerHTML = `<p class="text-center p-8">Access Denied.</p>`;
                return;
            }

            const tabs = [
                { key: 'overview', label: 'Overview', icon: 'layout-dashboard' },
                { key: 'users', label: 'Manage Users', icon: 'users' },
                { key: 'jobs', label: 'Manage Jobs', icon: 'briefcase' },
                { key: 'reports', label: 'Job Reports', icon: 'flag' },
                { key: 'cvDatabase', label: 'CV Database', icon: 'database' },
            ];

            const tabsHtml = tabs.map(tab => {
                const isActive = state.adminActiveTab === tab.key;
                return `<button onclick="handleAdminTab('${tab.key}')" class="flex items-center gap-2 px-4 py-2 rounded-md text-sm font-medium ${isActive ? 'bg-indigo-100 text-indigo-700' : 'text-slate-600 hover:bg-slate-100'}">
                    <i data-lucide="${tab.icon}" class="w-4 h-4"></i>
                    <span>${tab.label}</span>
                    ${tab.key === 'reports' && state.reports.length > 0 ? `<span class="ml-auto inline-block py-0.5 px-2.5 leading-none text-center whitespace-nowrap align-baseline font-bold bg-red-600 text-white rounded-full">${state.reports.length}</span>` : ''}
                </button>`;
            }).join('');
            
            let contentHtml = '';
            switch(state.adminActiveTab) {
                case 'overview':
                    contentHtml = renderAdminOverview();
                    break;
                case 'users':
                    contentHtml = renderAdminUsersTable();
                    break;
                case 'jobs':
                    contentHtml = renderAdminJobsTable();
                    break;
                case 'reports':
                    contentHtml = renderAdminReportsTable();
                    break;
                case 'cvDatabase':
                    contentHtml = renderAdminCvDatabaseReport();
                    break;
            }


            views.adminDashboard.innerHTML = `
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
                     <div class="mb-8">
                         <h1 class="text-3xl font-bold text-slate-800">Admin Dashboard</h1>
                         <p class="text-slate-500">Platform Overview & Management</p>
                     </div>
                     <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                         <aside class="md:col-span-1">
                             <nav class="flex flex-col space-y-2">${tabsHtml}</nav>
                         </aside>
                         <div class="md:col-span-3">
                             ${contentHtml}
                         </div>
                     </div>
                </div>
            `;
            
            lucide.createIcons();

            // Re-render chart if on overview tab
            if(state.adminActiveTab === 'overview'){
                 renderAdminOverviewChart();
            }
        }

        function renderAdminCvDatabaseReport() {
            const totalCandidates = state.candidates.length;

            // Calculate experience breakdown
            const experienceBreakdown = {
                '0-2 years': 0,
                '3-5 years': 0,
                '6-10 years': 0,
                '10+ years': 0,
            };
            const totalExperience = state.candidates.reduce((acc, c) => acc + (parseInt(c.experience) || 0), 0);
            state.candidates.forEach(c => {
                const exp = parseInt(c.experience) || 0;
                if (exp <= 2) experienceBreakdown['0-2 years']++;
                else if (exp <= 5) experienceBreakdown['3-5 years']++;
                else if (exp <= 10) experienceBreakdown['6-10 years']++;
                else experienceBreakdown['10+ years']++;
            });
            const averageExperience = totalCandidates > 0 ? (totalExperience / totalCandidates).toFixed(1) : 0;

            // Top skills
            const allSkills = state.candidates.flatMap(c => (c.skills || '').toLowerCase().split(',').map(s => s.trim()).filter(Boolean));
            const skillCounts = allSkills.reduce((acc, skill) => {
                acc[skill] = (acc[skill] || 0) + 1;
                return acc;
            }, {});
            const topSkills = Object.entries(skillCounts)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 5);

            // Find most recent candidates
            const recentCandidates = state.candidates
                .map(candidate => {
                    const user = state.allUsers[candidate.id];
                    return {
                        ...candidate,
                        joinedDate: user ? user.joinedDate : null
                    };
                })
                .filter(c => c.joinedDate) // Only include candidates with a join date
                .sort((a, b) => b.joinedDate.toDate() - a.joinedDate.toDate())
                .slice(0, 5);

            const recentCandidatesHtml = recentCandidates.map(candidate => `
                <tr class="hover:bg-slate-50">
                    <td class="p-4">${candidate.name}</td>
                    <td class="p-4">${candidate.location || 'N/A'}</td>
                    <td class="p-4">${candidate.experience || '0'} years</td>
                    <td class="p-4">${candidate.joinedDate.toDate().toLocaleDateString('en-ZA')}</td>
                    <td class="p-4 text-right"><button onclick="showCandidateDetails('${candidate.id}')" class="text-sm font-medium text-indigo-600 hover:text-indigo-800">View</button></td>
                </tr>
            `).join('');


            const html = `
                <div class="space-y-8">
                     <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 bg-white p-6 rounded-xl border border-slate-200">
                            <h3 class="text-lg font-bold text-slate-800 mb-4">Experience Distribution</h3>
                            <canvas id="admin-cv-chart" class="max-h-80"></canvas>
                        </div>
                        <div class="bg-white p-6 rounded-xl border border-slate-200">
                             <h3 class="text-lg font-bold text-slate-800 mb-4">Quick Stats</h3>
                             <dl class="space-y-4">
                                <div class="flex justify-between"><dt class="text-slate-500">Total Profiles</dt><dd class="font-semibold text-slate-800">${totalCandidates}</dd></div>
                                <div class="flex justify-between"><dt class="text-slate-500">Avg. Experience</dt><dd class="font-semibold text-slate-800">${averageExperience} years</dd></div>
                                <div>
                                     <dt class="text-slate-500 mb-2">Top 5 Skills</dt>
                                     <dd class="flex flex-wrap gap-2">
                                        ${topSkills.map(([skill]) => `<span class="bg-slate-100 text-slate-600 text-xs font-medium px-2 py-1 rounded-md capitalize">${skill}</span>`).join('')}
                                     </dd>
                                </div>
                             </dl>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
                        <h3 class="text-lg font-bold text-slate-800 p-4 border-b">Recently Joined Candidates</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-50 text-xs text-slate-500 uppercase">
                                    <tr>
                                        <th class="p-4 text-left">Name</th>
                                        <th class="p-4 text-left">Location</th>
                                        <th class="p-4 text-left">Experience</th>
                                        <th class="p-4 text-left">Joined</th>
                                        <th class="p-4 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${recentCandidates.length > 0 ? recentCandidatesHtml : '<tr><td colspan="5" class="text-center p-8 text-slate-500">No candidate profiles found.</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            // Delay chart rendering to ensure canvas is in the DOM
            setTimeout(() => {
                const ctx = document.getElementById('admin-cv-chart');
                if (ctx) {
                    const existingChart = Chart.getChart(ctx);
                    if (existingChart) {
                        existingChart.destroy();
                    }
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(experienceBreakdown),
                            datasets: [{
                                label: 'Candidates',
                                data: Object.values(experienceBreakdown),
                                backgroundColor: ['#a5b4fc', '#818cf8', '#6366f1', '#4f46e5'],
                                borderColor: '#fff',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'top',
                                }
                            }
                        }
                    })
                }
            }, 0);


            return html;
        }

        function renderAdminOverview() {
            const totalUsers = Object.keys(state.allUsers).length;
            const userCounts = Object.values(state.allUsers).reduce((acc, user) => {
                acc[user.type] = (acc[user.type] || 0) + 1;
                return acc;
            }, { seeker: 0, recruiter: 0 });

             return `
                <div>
                    <!-- Stat Cards -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-xl border border-slate-200"><h3 class="text-sm font-medium text-slate-500">Total Users</h3><p class="text-3xl font-bold text-slate-800 mt-2">${totalUsers}</p></div>
                        <div class="bg-white p-6 rounded-xl border border-slate-200"><h3 class="text-sm font-medium text-slate-500">Total Jobs</h3><p class="text-3xl font-bold text-slate-800 mt-2">${state.jobs.length}</p></div>
                        <div class="bg-white p-6 rounded-xl border border-slate-200"><h3 class="text-sm font-medium text-slate-500">Total Applications</h3><p class="text-3xl font-bold text-slate-800 mt-2">${state.applications.length}</p></div>
                        <div class="bg-white p-6 rounded-xl border border-slate-200"><h3 class="text-sm font-medium text-slate-500">Open Reports</h3><p class="text-3xl font-bold text-red-600 mt-2">${state.reports.length}</p></div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 bg-white p-6 rounded-xl border border-slate-200">
                             <h3 class="text-lg font-bold text-slate-800 mb-4">User Roles</h3>
                             <canvas id="admin-user-chart" class="max-h-80"></canvas>
                        </div>
                        <div class="bg-white p-6 rounded-xl border border-slate-200">
                             <h3 class="text-lg font-bold text-slate-800 mb-4">Quick Stats</h3>
                             <dl class="space-y-4">
                                 <div class="flex justify-between"><dt class="text-slate-500">Job Seekers</dt><dd class="font-semibold text-slate-800">${userCounts.seeker || 0}</dd></div>
                                 <div class="flex justify-between"><dt class="text-slate-500">Recruiters</dt><dd class="font-semibold text-slate-800">${userCounts.recruiter || 0}</dd></div>
                             </dl>
                        </div>
                    </div>
                </div>`;
        }
        
        function renderAdminOverviewChart() {
             const userCounts = Object.values(state.allUsers).reduce((acc, user) => {
                acc[user.type] = (acc[user.type] || 0) + 1;
                return acc;
            }, { seeker: 0, recruiter: 0 });

             const ctx = document.getElementById('admin-user-chart');
            if (ctx) {
                 if(state.adminDashboardChart) state.adminDashboardChart.destroy();
                state.adminDashboardChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Seekers', 'Recruiters'],
                        datasets: [{
                            label: 'User Count',
                            data: [userCounts.seeker, userCounts.recruiter],
                            backgroundColor: ['rgba(79, 70, 229, 0.7)', 'rgba(30, 64, 175, 0.7)'],
                            borderColor: ['rgba(79, 70, 229, 1)', 'rgba(30, 64, 175, 1)'],
                            borderWidth: 1,
                            borderRadius: 4,
                        }]
                    },
                    options: {
                         indexAxis: 'y',
                         responsive: true,
                         scales: { x: { beginAtZero: true, ticks: { precision: 0 } } },
                         plugins: { legend: { display: false } }
                    }
                });
            }
        }

        function renderAdminUsersTable() {
            const users = Object.entries(state.allUsers).map(([id, data]) => ({ id, ...data }));
            const usersHtml = users.map(user => {
                const isSuspended = user.suspended === true;
                return `
                <tr class="hover:bg-slate-50 ${isSuspended ? 'bg-red-50 text-slate-500' : ''}">
                    <td class="p-4">${user.name} ${isSuspended ? '<span class="text-xs font-semibold text-red-600">(Suspended)</span>' : ''}</td>
                    <td class="p-4">${user.email}</td>
                    <td class="p-4"><span class="status-badge ${user.type === 'seeker' ? 'status-applied' : 'status-hired'}">${user.type}</span></td>
                    <td class="p-4">${user.joinedDate ? user.joinedDate.toDate().toLocaleDateString('en-ZA') : 'N/A'}</td>
                    <td class="p-4 flex gap-2 justify-end">
                        <button onclick="showSuspendUserModal('${user.id}', '${user.name.replace(/'/g, "\\'")}', ${isSuspended})" class="text-sm font-medium ${isSuspended ? 'text-emerald-600 hover:text-emerald-800' : 'text-amber-600 hover:text-amber-800'}">
                            ${isSuspended ? 'Unsuspend' : 'Suspend'}
                        </button>
                        <button onclick="showDeleteUserModal('${user.id}', '${user.name.replace(/'/g, "\\'")}')" class="text-sm font-medium text-red-600 hover:text-red-800">Delete</button>
                    </td>
                </tr>
            `}).join('');
            return `<div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
                <h3 class="text-lg font-bold text-slate-800 p-4 border-b">Manage Users</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-slate-50 text-xs text-slate-500 uppercase"><th class="p-4 text-left">Name</th><th class="p-4 text-left">Email</th><th class="p-4 text-left">Type</th><th class="p-4 text-left">Joined</th><th class="p-4 text-right">Actions</th></thead>
                        <tbody>${usersHtml}</tbody>
                    </table>
                </div>
            </div>`;
        }

        function renderAdminJobsTable() {
            const jobsHtml = state.jobs.map(job => {
                const applicantCount = state.applications.filter(app => app.jobId === job.id).length;
                return `
                <tr class="hover:bg-slate-50">
                    <td class="p-4">${job.title}</td>
                    <td class="p-4">${job.company}</td>
                    <td class="p-4">${job.postedDate.toDate().toLocaleDateString('en-ZA')}</td>
                    <td class="p-4 text-center">${applicantCount}</td>
                    <td class="p-4 flex gap-2 justify-end">
                        <button onclick="showJobDetails('${job.id}')" class="text-sm font-medium text-indigo-600 hover:text-indigo-800">View</button>
                        <button onclick="showAdminDeleteJobModal('${job.id}', '${job.title.replace(/'/g, "\\'")}')" class="text-sm font-medium text-red-600 hover:text-red-800">Delete</button>
                    </td>
                </tr>
            `}).join('');
             return `<div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
                <h3 class="text-lg font-bold text-slate-800 p-4 border-b">Manage Jobs</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-slate-50 text-xs text-slate-500 uppercase"><th class="p-4 text-left">Title</th><th class="p-4 text-left">Company</th><th class="p-4 text-left">Posted</th><th class="p-4 text-center">Apps</th><th class="p-4 text-right">Actions</th></thead>
                        <tbody>${jobsHtml}</tbody>
                    </table>
                </div>
            </div>`;
        }

        function renderAdminReportsTable() {
            const reportsHtml = state.reports.map(report => {
                const job = state.jobs.find(j => j.id === report.jobId);
                return `
                <tr class="hover:bg-slate-50">
                    <td class="p-4">${job ? job.title : 'Job Deleted'}</td>
                    <td class="p-4">${report.reason}</td>
                    <td class="p-4">${report.reportedDate.toDate().toLocaleString('en-ZA')}</td>
                    <td class="p-4 flex gap-2 justify-end">
                        <button onclick="showJobDetails('${report.jobId}')" class="text-sm font-medium text-indigo-600 hover:text-indigo-800">View Job</button>
                        <button onclick="handleDismissReport('${report.id}')" class="text-sm font-medium text-emerald-600 hover:text-emerald-800">Dismiss</button>
                        <button onclick="showAdminDeleteJobModal('${report.jobId}', '${job ? job.title.replace(/'/g, "\\'") : 'this job'}')" class="text-sm font-medium text-red-600 hover:text-red-800">Delete Job</button>
                    </td>
                </tr>
            `}).join('');
             return `<div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
                <h3 class="text-lg font-bold text-slate-800 p-4 border-b">Manage Reports</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-slate-50 text-xs text-slate-500 uppercase"><th class="p-4 text-left">Job Title</th><th class="p-4 text-left">Reason</th><th class="p-4 text-left">Date</th><th class="p-4 text-right">Actions</th></thead>
                        <tbody>${reportsHtml}</tbody>
                    </table>
                     ${state.reports.length === 0 ? '<p class="text-center text-slate-500 p-8">No open reports.</p>' : ''}
                </div>
            </div>`;
        }


        // --- MODAL HANDLING ---
        function showModal(modalEl) { document.body.classList.add('overflow-hidden'); modalEl.classList.remove('hidden'); setTimeout(() => modalEl.classList.add('active'), 10); }
        function closeModal(modalId) { 
            const modalEl = document.getElementById(modalId);
            if (!modalEl) return;
            document.body.classList.remove('overflow-hidden'); 
            modalEl.classList.remove('active'); 
            setTimeout(() => modalEl.classList.add('hidden'), 300); 
        }
        
        function showLoginModal(type, mode = 'login') {
            const modalContent = loginModalEl.querySelector('.modal-content');
            const isLogin = mode === 'login';

            const nameField = isLogin ? '' : `
                <div>
                    <label for="name" class="text-sm font-medium text-slate-700">${type === 'seeker' ? 'Full Name' : 'Company Name'}</label>
                    <input id="name" name="name" type="text" autocomplete="name" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
            `;
            
            const passwordStrengthIndicator = isLogin ? '' : `
                <div id="password-strength-container" class="mt-2">
                    <div id="strength-meter" class="strength-meter"><div></div><div></div><div></div><div></div></div>
                    <ul id="password-criteria" class="strength-criteria text-xs space-y-1 mt-2">
                        <li data-criterion="length" class="flex items-center"><i data-lucide="x" class="cross-icon w-3 h-3 mr-1"></i><i data-lucide="check" class="check-icon w-3 h-3 mr-1"></i>At least 8 characters</li>
                        <li data-criterion="uppercase" class="flex items-center"><i data-lucide="x" class="cross-icon w-3 h-3 mr-1"></i><i data-lucide="check" class="check-icon w-3 h-3 mr-1"></i>One uppercase letter</li>
                        <li data-criterion="number" class="flex items-center"><i data-lucide="x" class="cross-icon w-3 h-3 mr-1"></i><i data-lucide="check" class="check-icon w-3 h-3 mr-1"></i>One number</li>
                        <li data-criterion="special" class="flex items-center"><i data-lucide="x" class="cross-icon w-3 h-3 mr-1"></i><i data-lucide="check" class="check-icon w-3 h-3 mr-1"></i>One special character (!@#$%^&*)</li>
                    </ul>
                </div>
            `;

            modalContent.innerHTML = `<div class="relative p-8">
                <button onclick="closeModal('login-modal')" class="text-slate-400 hover:text-slate-600 text-3xl absolute top-4 right-6 z-10">&times;</button>
                <div class="flex justify-center mb-4">
                    <img src="JA-logo.png" alt="JobAccess Logo" class="h-8 w-auto">
                </div>
                <h2 class="text-2xl font-bold text-slate-800 text-center mb-6">${type === 'recruiter' ? 'Recruiter' : 'Job Seeker'} ${isLogin ? 'Login' : 'Sign Up'}</h2>
                <div id="auth-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md mb-4 text-sm"></div>
                <form id="auth-form">
                    <div class="space-y-4">
                        ${nameField}
                        <div>
                            <label for="email" class="text-sm font-medium text-slate-700">Email address</label>
                            <input id="email" name="email" type="email" autocomplete="email" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="password" class="text-sm font-medium text-slate-700">Password</label>
                             <div class="relative mt-1">
                                <input id="password" name="password" type="password" autocomplete="${isLogin ? 'current-password' : 'new-password'}" oninput="${isLogin ? '' : `checkPasswordStrength(this.value)`}" required class="block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                <button type="button" onclick="togglePasswordVisibility('password', this)" class="absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5">
                                    <i data-lucide="eye" class="h-5 w-5 text-gray-400"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    ${passwordStrengthIndicator}
                    ${isLogin ? `<div class="flex items-center justify-end mt-4">
                        <div class="text-sm">
                            <a href="#" onclick="showForgotPassword('${type}')" class="font-medium text-indigo-600 hover:text-indigo-500">Forgot your password?</a>
                        </div>
                    </div>` : ''}
                    <div class="mt-6">
                        <button type="submit" ${isLogin ? '' : 'disabled'} class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:bg-indigo-400 disabled:cursor-not-allowed">${isLogin ? 'Sign in' : 'Create Account'}</button>
                    </div>
                    <p class="mt-4 text-center text-sm text-slate-500">
                        ${isLogin ? 'Not a member?' : 'Already have an account?'}
                        <a href="#" onclick="showLoginModal('${type}', '${isLogin ? 'signup' : 'login'}')" class="font-medium text-indigo-600 hover:text-indigo-500">${isLogin ? 'Sign up here' : 'Sign in'}</a>
                    </p>
                </form>
            </div>`;

            const form = modalContent.querySelector('#auth-form');
            form.addEventListener('submit', (event) => {
                event.preventDefault();
                if (isLogin) {
                    handleLogin(event, type);
                } else {
                    handleSignUp(event, type);
                }
            });
            if (!isLogin) {
                checkPasswordStrength(''); // Set initial state for criteria UI
            }
            lucide.createIcons();
            showModal(loginModalEl);
        }

        function showJobDetails(jobId) {
            const job = state.jobs.find(j => j.id === jobId);
            if (!job) return;
            const modalContent = jobDetailsModalEl.querySelector('.modal-content');
            const hasApplied = state.currentUser && state.applications.find(app => app.jobId === job?.id);
            const isRecruiterOrAdmin = state.currentUser && (state.currentUser.type === 'recruiter' || state.currentUser.type === 'admin');
            const reportButtonHtml = `<div class="p-6 text-center text-xs text-slate-400">
                <a href="#" onclick="showReportJobModal('${job.id}')" class="inline-flex items-center hover:text-red-600 hover:underline"><i data-lucide="flag" class="w-3 h-3 mr-1"></i>Report this job</a>
            </div>`;
            const closingDateDetails = job.closingDate ? `Closes ${job.closingDate.toDate().toLocaleDateString('en-ZA', { year: 'numeric', month: 'long', day: 'numeric' })}` : '';
            modalContent.innerHTML = `<div class="p-8 border-b"><div class="flex justify-between items-start"><div><h2 class="text-2xl font-bold text-slate-800">${job.title}</h2><p class="text-slate-600 font-medium mt-1">${job.company} - <span class="text-slate-500 font-normal">${job.location}</span></p><p class="text-sm text-red-600 font-medium mt-1">${closingDateDetails}</p></div><button onclick="closeModal('job-details-modal')" class="text-slate-400 hover:text-slate-600 text-3xl">&times;</button></div></div><div class="p-8 overflow-y-auto"><h3 class="font-bold text-slate-800 mb-2">Job Description</h3><p class="text-slate-600 whitespace-pre-wrap">${job.description}</p></div><div class="p-6 bg-slate-50 border-t mt-auto"><button onclick="handleApply('${job.id}')" ${(hasApplied || isRecruiterOrAdmin) ? 'disabled' : ''} class="w-full bg-indigo-600 text-white font-medium py-3 px-4 rounded-lg shadow-sm hover:bg-indigo-700 transition-colors disabled:bg-slate-400 disabled:cursor-not-allowed">${hasApplied ? 'Applied' : 'Apply Now'}</button></div>${reportButtonHtml}`;
            lucide.createIcons();
            showModal(jobDetailsModalEl);
        }

        function showApplicantsModal(jobId) {
            const job = state.jobs.find(j => j.id === jobId);
            if (!job) return;

            const applicationsForJob = state.applications.filter(app => app.jobId === jobId);
            const applicants = applicationsForJob.map(app => {
                const candidate = state.candidates.find(c => c.id === app.candidateId);
                 // Add user data as fallback
                const user = state.allUsers[app.candidateId];
                return { ...candidate, ...user, id: app.candidateId, status: app.status };
            }).filter(Boolean);

            const applicantListHtml = applicants.map(candidate => { 
                const photoURL = candidate.photoURL || `https://placehold.co/100x100/6366f1/ffffff?text=${candidate.name.charAt(0)}`;
                return `<tr class="hover:bg-slate-50">
                    <td class="p-4 font-medium text-slate-800 flex items-center gap-3">
                        <img src="${photoURL}" class="w-8 h-8 rounded-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/100x100/6366f1/ffffff?text=${candidate.name.charAt(0)}'"/>
                        <span>${candidate.name}</span>
                    </td>
                    <td class="p-4 text-slate-600">${candidate.email || 'Not provided'}</td>
                    <td class="p-4 text-slate-500">${candidate.skills || ''}</td>
                    <td class="p-4"><span class="status-badge status-${candidate.status}">${candidate.status}</span></td>
                    <td class="p-4 text-right"><button onclick="showCandidateDetails('${candidate.id}')" class="text-indigo-600 hover:text-indigo-800 font-medium">View Profile</button></td>
                </tr>`; 
            }).join('');
            const modalContent = applicantsModalEl.querySelector('.modal-content');
            modalContent.innerHTML = `<div class="p-6 border-b flex justify-between items-center"><div><h2 class="text-xl font-bold text-slate-800">Applicants for ${job.title}</h2><p class="text-sm text-slate-500">${applicants.length} total applicants</p></div><button onclick="closeModal('applicants-modal')" class="text-slate-400 hover:text-slate-600 text-3xl">&times;</button></div><div class="overflow-y-auto"><table class="w-full text-sm text-left"><thead class="bg-slate-50 text-xs text-slate-500 uppercase tracking-wider sticky top-0"><tr><th class="p-4">Name</th><th class="p-4">Email</th><th class="p-4">Top Skills</th><th class="p-4">Status</th><th class="p-4"></th></tr></thead><tbody>${applicantListHtml}</tbody></table>${applicants.length === 0 ? `<div class="text-center p-8 text-slate-500">No applicants for this position yet.</div>` : ''}</div>`;
            lucide.createIcons();
            showModal(applicantsModalEl);
        }

        function showForgotPassword(type) {
            const modalContent = loginModalEl.querySelector('.modal-content');
            modalContent.innerHTML = `<div class="relative p-8">
                <button onclick="closeModal('login-modal')" class="text-slate-400 hover:text-slate-600 text-3xl absolute top-4 right-6 z-10">&times;</button>
                <div class="flex justify-center mb-4">
                    <img src="JA-logo.png" alt="JobAccess Logo" class="h-8 w-auto">
                </div>
                <h2 class="text-2xl font-bold text-slate-800 text-center mb-2">Reset Password</h2>
                <div id="auth-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md mb-4 text-sm"></div>
                <p class="text-slate-600 text-sm mb-4 text-center">Enter your email address and we will send you a link to reset your password.</p>
                <form onsubmit="handlePasswordReset(event)">
                    <div class="space-y-4">
                        <div>
                            <label for="reset-email" class="text-sm font-medium text-slate-700">Email address</label>
                            <input id="reset-email" name="email" type="email" autocomplete="email" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                    </div>
                    <div class="mt-6">
                        <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Send Reset Link</button>
                    </div>
                    <p class="mt-4 text-center text-sm text-slate-500">
                        <a href="#" onclick="showLoginModal('${type}', 'login')" class="font-medium text-indigo-600 hover:text-indigo-500">Back to Login</a>
                    </p>
                </form>
            </div>`;
        }

        async function handlePasswordReset(event) {
            event.preventDefault();
            const email = event.target.email.value;
            const modalContent = loginModalEl.querySelector('.modal-content');
            const errorDiv = modalContent.querySelector('#auth-error');
            const submitButton = event.target.querySelector('button[type="submit"]');

            try {
                await sendPasswordResetEmail(auth, email);
                modalContent.innerHTML = `<div class="p-8 text-center">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-emerald-100">
                        <i data-lucide="check" class="h-6 w-6 text-emerald-600"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-800 mt-4">Check Your Email</h2>
                    <p class="text-slate-600 text-sm my-4">We've sent a password reset link to ${email}.</p>
                    <button onclick="closeModal('login-modal')" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Close</button>
                </div>`;
                lucide.createIcons();
            } catch (error) {
                if (error.code === 'auth/too-many-requests') {
                    startAuthLockoutTimer(30, submitButton, errorDiv, 'Send Reset Link');
                } else if (errorDiv) {
                    errorDiv.textContent = error.message;
                    errorDiv.classList.remove('hidden');
                }
            }
        }
        
        // --- AUTHENTICATION & MENU ---
        async function handleLogin(event, type) {
            const email = event.target.email.value;
            const password = event.target.password.value;
            const errorDiv = document.getElementById('auth-error');
            const submitButton = event.target.querySelector('button[type="submit"]');
            try {
                await signInWithEmailAndPassword(auth, email, password);
                closeModal('login-modal');
            } catch (error) {
                 if (error.code === 'auth/too-many-requests') {
                    startAuthLockoutTimer(30, submitButton, errorDiv, 'Sign in');
                } else if (error.code === 'auth/invalid-credential') {
                    errorDiv.textContent = 'Invalid email or password. Please check your credentials and try again.';
                    errorDiv.classList.remove('hidden');
                } else {
                    errorDiv.textContent = error.message;
                    errorDiv.classList.remove('hidden');
                }
            }
        }

        async function handleSignUp(event, type) {
            const name = event.target.name.value;
            const email = event.target.email.value;
            const password = event.target.password.value;
            const errorDiv = document.getElementById('auth-error');
            const submitButton = event.target.querySelector('button[type="submit"]');
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                const nameParts = name.split(' ');
                const initials = nameParts.length > 1 ? `${nameParts[0][0]}${nameParts[nameParts.length - 1][0]}` : name.substring(0, 2);
                const photoURL = `https://placehold.co/100x100/6366f1/ffffff?text=${initials.toUpperCase()}`;

                // Create user document in Firestore
                await setDoc(doc(db, "users", user.uid), {
                    name: name,
                    email: email,
                    type: type,
                    savedJobs: [],
                    photoURL: photoURL,
                    joinedDate: Timestamp.now()
                });

                if (type === 'seeker') {
                    // Create profile document in Firestore
                    await setDoc(doc(db, "profiles", user.uid), {
                        name: name,
                        email: email,
                        skills: '',
                        experience: '0',
                        location: '',
                        jobType: 'Full-time',
                        phone: '',
                        linkedin: '',
                        github: '',
                        summary: 'A passionate job seeker ready for new opportunities.',
                        workExperience: [],
                        education: [],
                        projects: [],
                        cvFileName: '',
                        photoURL: photoURL
                    });
                }
                
                sendWelcomeEmail(name, email, type);
                closeModal('login-modal');
            } catch (error) {
                 if (error.code === 'auth/too-many-requests') {
                    startAuthLockoutTimer(30, submitButton, errorDiv, 'Create Account');
                } else {
                    errorDiv.textContent = error.message;
                    errorDiv.classList.remove('hidden');
                }
            }
        }
        
        async function handleUpdateProfile() {
            if (!state.currentUser) return;

            const profileForm = document.getElementById('profile-form');
            if (!profileForm) return;

            const formData = new FormData(profileForm);
            const updatedProfile = {
                name: formData.get('name'),
                location: formData.get('location'),
                phone: formData.get('phone'),
                linkedin: formData.get('linkedin'),
                github: formData.get('github'),
                skills: formData.get('skills'),
                experience: formData.get('experience'),
                summary: formData.get('summary'),
                jobType: formData.get('jobType') || 'Full-time',
            };

            if (state.newPhotoPreview) {
                // In a real app, you would upload this to Firebase storage and get a URL.
                // For this simulation, we'll use the base64 data URL directly.
                updatedProfile.photoURL = state.newPhotoPreview;
                console.log(`Simulating upload of new profile photo.`);
            }

            if (state.selectedCvFile) {
                // In a real app, upload state.selectedCvFile to Firebase Storage here.
                // For simulation, we'll just use its name.
                updatedProfile.cvFileName = state.selectedCvFile.name;
                console.log(`Simulating upload of ${state.selectedCvFile.name}`);
            }

            const profileDocRef = doc(db, "profiles", state.currentUser.uid);
            const userDocRef = doc(db, "users", state.currentUser.uid);
            try {
                await setDoc(profileDocRef, updatedProfile, { merge: true });
                // Also update user collection if name or photoURL changed
                const userUpdateData = {};
                if (updatedProfile.name) userUpdateData.name = updatedProfile.name;
                if (updatedProfile.photoURL) userUpdateData.photoURL = updatedProfile.photoURL;

                if (Object.keys(userUpdateData).length > 0) {
                    await setDoc(userDocRef, userUpdateData, { merge: true });
                }
                
                state.selectedCvFile = null; // Reset after save
                state.newPhotoPreview = null;
                showConfirmationModal("Profile Updated", "Your profile has been successfully updated.", () => closeModal('confirmation-modal'), true, false, false);
            } catch (error) {
                console.error("Error updating profile: ", error);
                showConfirmationModal("Update Failed", "There was an error updating your profile.", () => closeModal('confirmation-modal'), false, true, false);
            }
        }

        async function handleUpdateCompanyProfile() {
            if (!state.currentUser || state.currentUser.type !== 'recruiter') return;

            const form = document.getElementById('company-profile-form');
            if (!form) return;

            const formData = new FormData(form);
            const updatedData = {
                name: formData.get('name'),
                phone: formData.get('phone'),
                linkedin: formData.get('linkedin'),
                website: formData.get('website'),
                description: formData.get('description'),
            };

            if (state.newPhotoPreview) {
                updatedData.photoURL = state.newPhotoPreview;
            }

            const userDocRef = doc(db, "users", state.currentUser.uid);
            try {
                await setDoc(userDocRef, updatedData, { merge: true });
                state.newPhotoPreview = null;
                showConfirmationModal("Company Profile Updated", "Your company profile has been successfully updated.", () => closeModal('confirmation-modal'), true, false, false);
            } catch (error) {
                console.error("Error updating company profile: ", error);
                showConfirmationModal("Update Failed", "There was an error updating your company profile.", () => closeModal('confirmation-modal'), false, true, false);
            }
        }

        function startAuthLockoutTimer(duration, button, errorDiv, originalText) {
            if (state.authLockoutActive) return;
            state.authLockoutActive = true;
            
            button.disabled = true;
            let timeLeft = duration;

            const timerInterval = setInterval(() => {
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    button.disabled = false;
                    errorDiv.classList.add('hidden');
                    errorDiv.textContent = '';
                    state.authLockoutActive = false;
                    button.innerHTML = originalText;
                } else {
                    const message = `For security, access has been temporarily blocked due to too many failed attempts. Please try again in ${timeLeft} seconds.`;
                    errorDiv.textContent = message;
                    errorDiv.classList.remove('hidden');
                    button.innerHTML = `<span class="flex items-center justify-center gap-2"><i data-lucide="timer" class="w-4 h-4 animate-spin"></i><span>Try again in ${timeLeft}s</span></span>`;
                    lucide.createIcons(); // Re-render icon
                    timeLeft--;
                }
            }, 1000);
        }

        function sendWelcomeEmail(name, email, type) {
            console.log(`%c📧 Sending welcome email to ${name} (${email})...`, 'color: #10b981;');
            
            const subject = "Welcome to JobAccess!";
            let body = `Hi ${name},\n\nWelcome to JobAccess! We're thrilled to have you join our community.`;

            if (type === 'seeker') {
                body += `\n\nYour journey to finding your next big opportunity starts now. You can start by searching for jobs or completing your profile to attract top recruiters.\n\nBest of luck!`;
            } else {
                body += `\n\nYour journey to finding the best talent starts now. You can start by posting a job or searching our CV database to find your next great hire.\n\nHappy recruiting!`;
            }

            body += `\n\nRegards,\nThe JobAccess Team`;

            console.log(`%c--- Email Content ---`, 'font-weight: bold;');
            console.log(`To: ${email}`);
            console.log(`Subject: ${subject}`);
            console.log(body);
            console.log(`%c---------------------`, 'font-weight: bold;');
            console.log('%c✅ Email sent (simulation).', 'color: #10b981;');
        }

        function handleLogout() {
            showConfirmationModal(
                "Confirm Sign Out",
                "Are you sure you want to sign out?",
                () => {
                    signOut(auth);
                    closeModal('confirmation-modal');
                },
                false, // isSuccess
                false, // isError
                true   // showCancel
            );
        }

        function toggleUserDropdown() { document.getElementById('user-dropdown').classList.toggle('hidden'); }
        function toggleLoginDropdown() { document.getElementById('login-dropdown').classList.toggle('hidden'); }
        
        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            const openIcon = document.getElementById('mobile-menu-open-icon');
            const closeIcon = document.getElementById('mobile-menu-close-icon');
            menu.classList.toggle('hidden');
            openIcon.classList.toggle('hidden');
            closeIcon.classList.toggle('hidden');
        }
        
        function togglePasswordVisibility(inputId, buttonEl) {
            const input = document.getElementById(inputId);
            
            if (input.type === "password") {
                input.type = "text";
                buttonEl.innerHTML = '<i data-lucide="eye-off" class="h-5 w-5 text-gray-400"></i>';
            } else {
                input.type = "password";
                buttonEl.innerHTML = '<i data-lucide="eye" class="h-5 w-5 text-gray-400"></i>';
            }
            lucide.createIcons();
        }

        function checkPasswordStrength(password) {
            const meter = document.getElementById('strength-meter');
            const criteriaList = document.getElementById('password-criteria');
            const submitButton = document.querySelector('#auth-form button[type="submit"]');

            if (!meter || !criteriaList) return;

            const criteria = {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                number: /[0-9]/.test(password),
                special: /[!@#$%^&*]/.test(password)
            };

            let score = 0;
            for (const key in criteria) {
                const criterionEl = criteriaList.querySelector(`[data-criterion="${key}"]`);
                if (criteria[key]) {
                    score++;
                    criterionEl.classList.remove('invalid');
                    criterionEl.classList.add('valid');
                } else {
                    criterionEl.classList.remove('valid');
                    criterionEl.classList.add('invalid');
                }
            }

            meter.className = 'strength-meter'; // Reset
            if (score === 1) meter.classList.add('weak');
            else if (score === 2) meter.classList.add('medium');
            else if (score === 3) meter.classList.add('strong');
            else if (score === 4) meter.classList.add('very-strong');

            if (submitButton) {
                submitButton.disabled = score !== 4;
            }
        }


        function handleCvFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            state.selectedCvFile = file; // Store the file object

            const fileNameEl = document.getElementById('cv-file-name');
            const uploadTextEl = document.getElementById('cv-upload-text');
            
            if (fileNameEl) {
                fileNameEl.textContent = `New file: ${file.name}`;
            }
            if (uploadTextEl) {
                uploadTextEl.textContent = 'Replace file';
            }
        }

        function handlePhotoFileSelect(event, previewId) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                state.newPhotoPreview = e.target.result;
                const previewImg = document.getElementById(previewId);
                if (previewImg) {
                    previewImg.src = e.target.result;
                }
            };
            reader.readAsDataURL(file);
        }

        function showPostJobModal() {
            const modalContent = postJobModalEl.querySelector('.modal-content');
            const today = getSimulatedNow().toISOString().split('T')[0];
            modalContent.innerHTML = `
                <form id="post-job-form" class="flex flex-col h-full">
                    <div class="p-6 border-b flex-shrink-0">
                        <div class="flex justify-between items-center">
                            <h2 class="text-2xl font-bold text-slate-800">Post a New Job</h2>
                            <button type="button" onclick="closeModal('post-job-modal')" class="text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
                        </div>
                    </div>
                    <div class="p-8 overflow-y-auto flex-grow">
                        <div class="space-y-6">
                            <div>
                                <div class="flex justify-between items-center">
                                    <label for="job-title" class="block text-sm font-medium text-slate-700">Job Title</label>
                                    <button type="button" onclick="generateJobDescription()" class="flex items-center gap-1 text-xs font-medium text-indigo-600 hover:text-indigo-800">
                                        <i data-lucide="sparkles" class="w-3 h-3"></i>
                                        <span>Generate with AI</span>
                                    </button>
                                </div>
                                <input type="text" id="job-title" name="title" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                <div>
                                    <label for="job-city" class="block text-sm font-medium text-slate-700">City</label>
                                    <input type="text" id="job-city" name="city" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div>
                                    <label for="job-province" class="block text-sm font-medium text-slate-700">Province</label>
                                    <select id="job-province" name="province" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                        <option>Eastern Cape</option>
                                        <option>Free State</option>
                                        <option selected>Gauteng</option>
                                        <option>KwaZulu-Natal</option>
                                        <option>Limpopo</option>
                                        <option>Mpumalanga</option>
                                        <option>North West</option>
                                        <option>Northern Cape</option>
                                        <option>Western Cape</option>
                                    </select>
                                </div>
                            </div>
                             <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                <div>
                                    <label for="job-type" class="block text-sm font-medium text-slate-700">Job Type</label>
                                    <select id="job-type" name="type" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                        <option>Full-time</option>
                                        <option>Part-time</option>
                                        <option>Contract</option>
                                        <option>Internship</option>
                                        <option>Hybrid</option>
                                        <option>Remote</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="job-closing-date" class="block text-sm font-medium text-slate-700">Closing Date</label>
                                    <input type="date" id="job-closing-date" name="closingDate" required min="${today}" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                            </div>
                             <div>
                                <label for="job-salary" class="block text-sm font-medium text-slate-700">Salary Range (Optional)</label>
                                <input type="text" id="job-salary" name="salary" placeholder="e.g., R30,000 - R40,000 per month" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="job-description" class="block text-sm font-medium text-slate-700">Job Description</label>
                                <textarea id="job-description" name="description" rows="8" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-slate-50"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="p-6 bg-slate-50 border-t flex justify-end flex-shrink-0">
                        <button type="submit" class="w-full sm:w-auto bg-indigo-600 text-white font-medium py-2.5 px-6 rounded-lg shadow-sm hover:bg-indigo-700 transition-colors">Post Job</button>
                    </div>
                </form>
            `;
             const form = modalContent.querySelector('#post-job-form');
             form.addEventListener('submit', handlePostJob);
            lucide.createIcons();
            showModal(postJobModalEl);
        }

        function showEditJobModal(jobId) {
            const job = state.jobs.find(j => j.id === jobId);
            if (!job) return;

            const [city, province] = job.location.split(', ');
            const provinces = ["Eastern Cape", "Free State", "Gauteng", "KwaZulu-Natal", "Limpopo", "Mpumalanga", "North West", "Northern Cape", "Western Cape"];
            const provinceOptions = provinces.map(p => `<option ${p === province ? 'selected' : ''}>${p}</option>`).join('');
            const jobTypes = ["Full-time", "Part-time", "Contract", "Internship", "Hybrid", "Remote"];
            const typeOptions = jobTypes.map(t => `<option ${t === job.type ? 'selected' : ''}>${t}</option>`).join('');
            const today = getSimulatedNow().toISOString().split('T')[0];
            const closingDateValue = job.closingDate ? job.closingDate.toDate().toISOString().split('T')[0] : '';


            const modalContent = postJobModalEl.querySelector('.modal-content');
            modalContent.innerHTML = `
                <form id="edit-job-form" class="flex flex-col h-full">
                    <div class="p-6 border-b flex-shrink-0">
                        <div class="flex justify-between items-center">
                            <h2 class="text-2xl font-bold text-slate-800">Edit Job Post</h2>
                            <button type="button" onclick="closeModal('post-job-modal')" class="text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
                        </div>
                    </div>
                    <div class="p-8 overflow-y-auto flex-grow">
                        <div class="space-y-6">
                             <div>
                                <label for="job-title" class="block text-sm font-medium text-slate-700">Job Title</label>
                                <input type="text" id="job-title" name="title" value="${job.title}" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                <div>
                                    <label for="job-city" class="block text-sm font-medium text-slate-700">City</label>
                                    <input type="text" id="job-city" name="city" value="${city}" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div>
                                    <label for="job-province" class="block text-sm font-medium text-slate-700">Province</label>
                                    <select id="job-province" name="province" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                        ${provinceOptions}
                                    </select>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                <div>
                                    <label for="job-type" class="block text-sm font-medium text-slate-700">Job Type</label>
                                    <select id="job-type" name="type" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                        ${typeOptions}
                                    </select>
                                </div>
                                 <div>
                                    <label for="job-closing-date" class="block text-sm font-medium text-slate-700">Closing Date</label>
                                    <input type="date" id="job-closing-date" name="closingDate" value="${closingDateValue}" required min="${today}" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                            </div>
                             <div>
                                <label for="job-salary" class="block text-sm font-medium text-slate-700">Salary Range (Optional)</label>
                                <input type="text" id="job-salary" name="salary" value="${job.salary || ''}" placeholder="e.g., R30,000 - R40,000 per month" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="job-description" class="block text-sm font-medium text-slate-700">Job Description</label>
                                <textarea id="job-description" name="description" rows="8" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">${job.description}</textarea>
                            </div>
                        </div>
                    </div>
                    <div class="p-6 bg-slate-50 border-t flex justify-end flex-shrink-0">
                        <button type="submit" class="w-full sm:w-auto bg-indigo-600 text-white font-medium py-2.5 px-6 rounded-lg shadow-sm hover:bg-indigo-700 transition-colors">Save Changes</button>
                    </div>
                </form>
            `;
            const form = modalContent.querySelector('#edit-job-form');
            form.addEventListener('submit', (event) => handleUpdateJob(event, jobId));
            lucide.createIcons();
            showModal(postJobModalEl);
        }

        async function handleUpdateJob(event, jobId) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const city = formData.get('city');
            const province = formData.get('province');
            
            const updatedData = {
                title: formData.get('title'),
                location: `${city}, ${province}`,
                type: formData.get('type'),
                description: formData.get('description'),
                closingDate: Timestamp.fromDate(new Date(formData.get('closingDate'))),
                salary: formData.get('salary') || ''
            };

            const jobDocRef = doc(db, "jobs", jobId);
            try {
                await updateDoc(jobDocRef, updatedData);
                console.log("Job updated successfully");
                closeModal('post-job-modal');
            } catch (error) {
                console.error("Error updating job: ", error);
                showConfirmationModal("Update Failed", "Failed to update job. Please try again.", () => closeModal('confirmation-modal'), false, true, false);
            }
        }

        async function generateJobDescription() {
            const jobTitleInput = document.getElementById('job-title');
            const jobDescriptionTextarea = document.getElementById('job-description');
            const jobTitle = jobTitleInput.value;

            if (!jobTitle.trim()) {
                showConfirmationModal("Missing Information", "Please enter a job title before generating a description.", () => closeModal('confirmation-modal'), false, true, false);
                return;
            }

            // Show loading state
            jobDescriptionTextarea.value = "✨ Generating job description, please wait...";
            jobDescriptionTextarea.disabled = true;

            const apiKey = ""; // API key is handled by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            const systemPrompt = "You are an expert HR professional in South Africa. Your task is to write a clear, concise, and engaging job description.";
            const userQuery = `Write a detailed job description for a "${jobTitle}" position based in South Africa. The description should include the following sections: Key Responsibilities, Qualifications and Experience, and Desired Skills. The tone should be professional and appealing to potential candidates.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    jobDescriptionTextarea.value = candidate.content.parts[0].text;
                } else {
                    jobDescriptionTextarea.value = "Sorry, I couldn't generate a description for that title. Please write one manually.";
                }
            } catch (error) {
                console.error("Error generating job description:", error);
                jobDescriptionTextarea.value = "An error occurred while generating the description. Please check the console and try again, or write one manually.";
            } finally {
                jobDescriptionTextarea.disabled = false;
            }
        }

        async function handlePostJob(event) {
            event.preventDefault();
            if (!state.currentUser || state.currentUser.type !== 'recruiter') {
                showLoginModal('recruiter', 'login');
                return;
            }

            const formData = new FormData(event.target);
            const city = formData.get('city');
            const province = formData.get('province');
            const newJob = {
                title: formData.get('title'),
                location: `${city}, ${province}`,
                type: formData.get('type'),
                description: formData.get('description'),
                company: state.currentUser.name, // Use recruiter's company name
                recruiterId: state.currentUser.uid,
                postedDate: Timestamp.fromDate(getSimulatedNow()),
                closingDate: Timestamp.fromDate(new Date(formData.get('closingDate'))),
                salary: formData.get('salary') || ''
            };

            try {
                const docRef = await addDoc(collection(db, "jobs"), newJob);
                console.log("Job posted with ID: ", docRef.id);
                closeModal('post-job-modal');
                // The onSnapshot listener will automatically update the UI
            } catch (e) {
                console.error("Error adding document: ", e);
                showConfirmationModal("Post Failed", "There was an error posting your job. Please try again.", () => closeModal('confirmation-modal'), false, true, false);
            }
        }

        function showDeleteConfirmation(jobId) {
            const job = state.jobs.find(j => j.id === jobId);
            if (!job) return;

            const modalContent = confirmationModalEl.querySelector('.modal-content');
            modalContent.innerHTML = `
                <div class="p-8">
                    <div class="text-center">
                        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                            <i data-lucide="trash-2" class="h-6 w-6 text-red-600"></i>
                        </div>
                        <h3 class="mt-5 text-lg font-medium text-gray-900">Delete Job Post</h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500">
                                Are you sure you want to delete the job post for <strong class="text-slate-700">${job.title}</strong>? This action cannot be undone.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse rounded-b-2xl">
                    <button type="button" id="confirm-delete-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 sm:ml-3 sm:w-auto sm:text-sm">
                        Delete
                    </button>
                    <button type="button" onclick="closeModal('confirmation-modal')" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">
                        Cancel
                    </button>
                </div>
            `;
            modalContent.querySelector('#confirm-delete-btn').onclick = () => handleDeleteJob(jobId);
            lucide.createIcons();
            showModal(confirmationModalEl);
        }

        async function handleDeleteJob(jobId) {
             const jobDocRef = doc(db, "jobs", jobId);
            try {
                await deleteDoc(jobDocRef);
                console.log("Job deleted successfully");

                // If the deleted job was the selected one, select the first job in the list
                if(state.selectedJobId === jobId) {
                    state.selectedJobId = state.jobs.length > 0 ? state.jobs[0].id : null;
                }

                closeModal('confirmation-modal');
                // UI will update automatically via the onSnapshot listener
            } catch(error) {
                console.error("Error deleting job: ", error);
                showConfirmationModal("Delete Failed", "Failed to delete job. Please try again.", () => {
                    closeModal('confirmation-modal');
                }, false, true, false);
            }
        }
        
        function showReportJobModal(jobId) {
            const job = state.jobs.find(j => j.id === jobId);
            if (!job) return;

            const modalContent = reportJobModalEl.querySelector('.modal-content');
            modalContent.innerHTML = `
                <form id="report-job-form">
                     <div class="p-6 border-b">
                         <div class="flex justify-between items-center">
                             <h2 class="text-2xl font-bold text-slate-800">Report Job Posting</h2>
                             <button type="button" onclick="closeModal('report-job-modal')" class="text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
                         </div>
                     </div>
                     <div class="p-8">
                         <p class="text-sm text-slate-600 mb-4">You are reporting the job: <strong class="text-slate-800">${job.title}</strong> posted by <strong class="text-slate-800">${job.company}</strong>.</p>
                         <div class="space-y-6">
                             <div>
                                 <label for="report-reason" class="block text-sm font-medium text-slate-700">Reason</label>
                                 <select id="report-reason" name="reason" required class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                     <option>Spam or Scam</option>
                                     <option>Incorrect Information</option>
                                     <option>Discriminatory Content</option>
                                     <option>Offensive Content</option>
                                     <option>Broken Link or Application</option>
                                     <option>Other</option>
                                 </select>
                             </div>
                             <div>
                                 <label for="report-comments" class="block text-sm font-medium text-slate-700">Additional Comments (Optional)</label>
                                 <textarea id="report-comments" name="comments" rows="4" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                             </div>
                         </div>
                     </div>
                      <div class="p-6 bg-slate-50 border-t mt-auto flex justify-end">
                         <button type="submit" class="w-full sm:w-auto bg-red-600 text-white font-medium py-2.5 px-6 rounded-lg shadow-sm hover:bg-red-700 transition-colors">Submit Report</button>
                     </div>
                </form>
            `;
            
            const form = modalContent.querySelector('#report-job-form');
            form.addEventListener('submit', (event) => handleReportJob(event, jobId));
            showModal(reportJobModalEl);
        }

        async function handleReportJob(event, jobId) {
            event.preventDefault();
            if(!state.currentUser) {
                showLoginModal('seeker', 'login');
                return;
            }

            const formData = new FormData(event.target);
            const reportData = {
                jobId: jobId,
                reason: formData.get('reason'),
                comments: formData.get('comments'),
                reporterId: state.currentUser.uid,
                reporterEmail: state.currentUser.email,
                reportedDate: Timestamp.now()
            };

            try {
                await addDoc(collection(db, "reports"), reportData);
                const modalContent = reportJobModalEl.querySelector('.modal-content');
                modalContent.innerHTML = `
                    <div class="p-8 text-center">
                        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-emerald-100">
                            <i data-lucide="check" class="h-6 w-6 text-emerald-600"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-slate-800 mt-4">Report Submitted</h2>
                        <p class="text-slate-600 text-sm my-4">Thank you for helping us maintain the quality of our job listings. Our team will review your report shortly.</p>
                        <button type="button" onclick="closeModal('report-job-modal')" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Close</button>
                    </div>`;
                lucide.createIcons();

            } catch(error) {
                console.error("Error submitting report:", error);
                showConfirmationModal("Report Failed", "There was an error submitting your report. Please try again.", () => closeModal('confirmation-modal'), false, true, false);
            }

        }
        
        async function handleSaveJob(jobId) {
            if (!state.currentUser) {
                showLoginModal('seeker', 'login');
                return;
            }

            const userDocRef = doc(db, "users", state.currentUser.uid);
            const isSaved = state.savedJobs.includes(jobId);

            let updatedSavedJobs;
            if (isSaved) {
                updatedSavedJobs = state.savedJobs.filter(id => id !== jobId);
            } else {
                updatedSavedJobs = [...state.savedJobs, jobId];
            }
            
            try {
                await updateDoc(userDocRef, {
                    savedJobs: updatedSavedJobs
                });
                // The onSnapshot listener for the user will update the state
            } catch (error) {
                console.error("Error updating saved jobs: ", error);
                showConfirmationModal("Save Failed", "Could not save job. Please try again.", () => closeModal('confirmation-modal'), false, true, false);
            }
        }
        
        function timeAgo(date) {
            if (!date) return '';
            if (typeof date.toDate !== 'function') {
                return '';
            }
            const now = getSimulatedNow();
            const seconds = Math.floor((now - date.toDate()) / 1000);

            let interval = seconds / 31536000;
            if (interval > 1) {
                const years = Math.floor(interval);
                return `Posted ${years} year${years > 1 ? 's' : ''} ago`;
            }
            interval = seconds / 2592000;
            if (interval > 1) {
                const months = Math.floor(interval);
                return `Posted ${months} month${months > 1 ? 's' : ''} ago`;
            }
            interval = seconds / 86400;
            if (interval > 1) {
                const days = Math.floor(interval);
                if (days === 1) return "Posted yesterday";
                return `Posted ${days} days ago`;
            }
            interval = seconds / 3600;
            if (interval > 1) {
                const hours = Math.floor(interval);
                return `Posted ${hours} hour${hours > 1 ? 's' : ''} ago`;
            }
            interval = seconds / 60;
            if (interval > 1) {
                const minutes = Math.floor(interval);
                return `Posted ${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            }
            return "Posted just now";
        }

        // --- CV DATABASE FUNCTIONS ---
        async function handleDownloadProfilePdf(candidateId) {
            const candidate = state.candidates.find(c => c.id === candidateId);
            if (!candidate) return;

            console.log(`Simulating PDF profile download for ${candidate.name}`);

            const userEmail = candidate.email || state.allUsers[candidate.id]?.email || 'N/A';
            
            const dummyPdfContent = `
                PROFILE: ${candidate.name}
                ============================================

                CONTACT
                --------------------
                Email: ${userEmail}
                Phone: ${candidate.phone || 'N/A'}
                Location: ${candidate.location || 'N/A'}
                LinkedIn: ${candidate.linkedin || 'N/A'}
                GitHub: ${candidate.github || 'N/A'}

                SUMMARY
                --------
                ${candidate.summary || 'No summary provided.'}

                SKILLS
                -------
                ${candidate.skills || 'No skills listed.'}

                EXPERIENCE
                -----------
                ${candidate.experience || '0'} years

                ---
                This is a simulated PDF profile generated by JobAccess. For a real implementation, a library like jsPDF would be used.
            `;

            const blob = new Blob([dummyPdfContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Profile_${candidate.name.replace(/\s/g, '_')}.txt`; // Simulating PDF with .txt
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function handleDownloadCv(candidateId) {
            const candidate = state.candidates.find(c => c.id === candidateId);
            if (!candidate || !candidate.cvFileName) {
                showConfirmationModal(
                    "No CV Found",
                    "This candidate has not uploaded a CV yet.",
                    () => closeModal('confirmation-modal'),
                    false, // not success
                    true,  // is error
                    false  // no cancel button
                );
                return;
            }

            // In a real app, you would get a download URL from Firebase Storage.
            // For this simulation, we'll create a dummy file and trigger a download.
            console.log(`Simulating download for actual CV file: ${candidate.cvFileName}`);
            
            const dummyFileContent = `This is a simulation of downloading the CV file named "${candidate.cvFileName}".`;

            const blob = new Blob([dummyFileContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = candidate.cvFileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function showCandidateDetails(candidateId) {
            const candidate = state.candidates.find(c => c.id === candidateId);
            if (!candidate) return;
            
            // Get email from the allUsers object as a fallback
            const userEmail = state.allUsers[candidateId]?.email;
            const photoURL = candidate.photoURL || `https://placehold.co/100x100/6366f1/ffffff?text=${candidate.name.charAt(0)}`;

            const modalContent = candidateDetailsModalEl.querySelector('.modal-content');
            modalContent.innerHTML = `
                <div class="p-6 border-b flex justify-between items-start">
                    <div class="flex items-center gap-4">
                        <img src="${photoURL}" class="w-16 h-16 rounded-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/100x100/6366f1/ffffff?text=${candidate.name.charAt(0)}'"/>
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800">${candidate.name}</h2>
                            <p class="text-slate-500">${candidate.location || 'Location not specified'}</p>
                            <div class="flex items-center gap-4 mt-1">
                                <span class="text-sm text-slate-500 flex items-center gap-1"><i data-lucide="briefcase" class="w-4 h-4 text-slate-400"></i>${candidate.jobType || 'Full-time'}</span>
                                <span class="text-sm text-slate-500 flex items-center gap-1"><i data-lucide="trending-up" class="w-4 h-4 text-slate-400"></i>${candidate.experience || '0'} years experience</span>
                            </div>
                        </div>
                    </div>
                    <button onclick="closeModal('candidate-details-modal')" class="text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
                </div>
                <div class="p-8 overflow-y-auto">
                    <div class="space-y-6">
                        <div>
                            <h3 class="font-semibold text-slate-800 mb-2 uppercase text-xs tracking-wider">Contact Information</h3>
                             <div class="space-y-2">
                                <p class="text-slate-600 flex items-center gap-2"><i data-lucide="mail" class="w-4 h-4 text-slate-400 flex-shrink-0"></i><span>${candidate.email || userEmail || 'Email not provided'}</span></p>
                                <p class="text-slate-600 flex items-center gap-2"><i data-lucide="phone" class="w-4 h-4 text-slate-400 flex-shrink-0"></i><span>${candidate.phone || 'Phone not provided'}</span></p>
                            </div>
                        </div>
                         <div>
                            <h3 class="font-semibold text-slate-800 mb-2 uppercase text-xs tracking-wider">Online Presence</h3>
                             <div class="flex flex-col space-y-2">
                                ${candidate.linkedin ? `<a href="${candidate.linkedin}" target="_blank" class="text-indigo-600 hover:underline flex items-center gap-2">
                                    <i data-lucide="linkedin" class="w-4 h-4"></i>
                                    <span>LinkedIn Profile</span>
                                </a>` : ''}
                                ${candidate.github ? `
                                <a href="${candidate.github}" target="_blank" class="text-indigo-600 hover:underline flex items-center gap-2">
                                    <i data-lucide="github" class="w-4 h-4"></i>
                                    <span>GitHub Profile</span>
                                </a>` : ''}
                            </div>
                        </div>
                        <div>
                            <h3 class="font-semibold text-slate-800 mb-2 uppercase text-xs tracking-wider">Top Skills</h3>
                            <div class="flex flex-wrap gap-2">
                                ${candidate.skills ? candidate.skills.split(', ').map(skill => `<span class="bg-indigo-100 text-indigo-700 text-sm font-medium px-3 py-1 rounded-full">${skill}</span>`).join('') : '<p class="text-sm text-slate-500">No skills listed.</p>'}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="p-6 bg-slate-50 border-t mt-auto flex flex-wrap items-center justify-start gap-3">
                        <div>
                        <button onclick="handleDownloadProfilePdf('${candidate.id}')" class="text-slate-700 bg-slate-200 hover:bg-slate-300 font-medium py-2 px-4 rounded-lg shadow-sm transition-colors text-sm">Download Profile (PDF)</button>
                        <button onclick="handleDownloadCv('${candidate.id}')" class="ml-2 text-slate-700 bg-slate-200 hover:bg-slate-300 font-medium py-2 px-4 rounded-lg shadow-sm transition-colors text-sm disabled:bg-slate-100 disabled:text-slate-400 disabled:cursor-not-allowed" ${!candidate.cvFileName ? 'disabled' : ''}>Download CV</button>
                       </div>
                </div>
            `;
            lucide.createIcons();
            showModal(candidateDetailsModalEl);
        }

        function showCvFilterModal() {
            const modalContent = cvFilterModalEl.querySelector('.modal-content');
            const jobTypes = ["Full-time", "Part-time", "Contract", "Internship", "Hybrid", "Remote"];
            const jobTypeCheckboxes = jobTypes.map(type => `
                <div class="flex items-center">
                    <input id="type-${type.toLowerCase()}" name="jobType" value="${type}" type="checkbox" ${state.cvFilters.jobType.includes(type) ? 'checked' : ''} onchange="handleCvFilterChange(event)" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                    <label for="type-${type.toLowerCase()}" class="ml-3 text-sm text-gray-600">${type}</label>
                </div>
            `).join('');

            modalContent.innerHTML = `
                <div class="p-6 border-b">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-slate-800">Filter Candidates</h2>
                        <button type="button" onclick="closeModal('cv-filter-modal')" class="text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
                    </div>
                </div>
                <div class="p-8 space-y-6">
                      <div>
                        <label for="filter-skills" class="block text-sm font-medium text-slate-700">Skills</label>
                        <input type="text" id="filter-skills" name="skills" value="${state.cvFilters.skills}" oninput="handleCvFilterChange(event)" placeholder="e.g., React, Node.js" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="filter-experience" class="block text-sm font-medium text-slate-700">Minimum Experience</label>
                        <select id="filter-experience" name="experience" onchange="handleCvFilterChange(event)" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="any" ${state.cvFilters.experience === 'any' ? 'selected' : ''}>Any</option>
                            <option value="1" ${state.cvFilters.experience === '1' ? 'selected' : ''}>1+ years</option>
                            <option value="3" ${state.cvFilters.experience === '3' ? 'selected' : ''}>3+ years</option>
                            <option value="5" ${state.cvFilters.experience === '5' ? 'selected' : ''}>5+ years</option>
                            <option value="10" ${state.cvFilters.experience === '10' ? 'selected' : ''}>10+ years</option>
                        </select>
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-slate-700">Job Type</label>
                        <div class="mt-2 grid grid-cols-2 gap-2">
                           ${jobTypeCheckboxes}
                        </div>
                    </div>
                    <div>
                        <label for="filter-location" class="block text-sm font-medium text-slate-700">Location</label>
                        <input type="text" id="filter-location" name="location" value="${state.cvFilters.location}" oninput="handleCvFilterChange(event)" placeholder="e.g., Cape Town" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>
                <div class="p-6 bg-slate-50 border-t mt-auto flex justify-end">
                    <button type="button" onclick="applyCvFilters()" class="w-full sm:w-auto bg-indigo-600 text-white font-medium py-2.5 px-6 rounded-lg shadow-sm hover:bg-indigo-700 transition-colors">Apply Filters</button>
                </div>
            `;
            showModal(cvFilterModalEl);
        }

        function handleCvFilterChange(event) {
            const { name, value, type, checked } = event.target;
            if (type === 'checkbox') {
                if(checked) {
                    state.cvFilters.jobType.push(value);
                } else {
                    state.cvFilters.jobType = state.cvFilters.jobType.filter(item => item !== value);
                }
            } else {
                state.cvFilters[name] = value;
            }
        }

        function applyCvFilters() {
            closeModal('cv-filter-modal');
            renderCvDatabasePage();
        }

        async function handleApply(jobId) {
            if (!state.currentUser || state.currentUser.type !== 'seeker') {
                showLoginModal('seeker', 'login');
                return;
            }
            
            const job = state.jobs.find(j => j.id === jobId);
            if (!job) return;

            const hasApplied = state.applications.some(app => app.jobId === jobId);
            if (hasApplied) {
                console.log("Already applied for this job.");
                return;
            }

            showConfirmationModal(
                "Confirm Application",
                `Are you sure you want to apply for ${job.title}?`,
                async () => {
                    try {
                        const newApplication = {
                            jobId: jobId,
                            candidateId: state.currentUser.uid,
                            appliedDate: Timestamp.fromDate(getSimulatedNow()),
                            status: 'applied'
                        };
                        await addDoc(collection(db, "applications"), newApplication);

                        // Create notification for the recruiter
                        const recruiterId = job.recruiterId;
                        const applicantName = state.currentUser.name;
                        const message = `${applicantName} applied for your job: ${job.title}.`;
                        await createNotification(recruiterId, message, 'recruiterPipeline', job.id);

                        showConfirmationModal(
                            "Application Sent!",
                            "Your application has been successfully submitted.",
                            () => closeModal('confirmation-modal'),
                            true, // is success
                            false, // is error
                            false // no cancel button
                        );
                    } catch (e) {
                        console.error("Error submitting application: ", e);
                        showConfirmationModal(
                            "Application Failed",
                            "There was an error submitting your application. Please try again.",
                            () => closeModal('confirmation-modal'),
                            false, // not success
                            true, // is error
                            false // no cancel button
                        );
                    }
                }
            );
        }

        function showConfirmationModal(title, message, onConfirm, isSuccess = false, isError = false, showCancel = true, confirmButtonClass = 'bg-indigo-600 hover:bg-indigo-700') {
            const modalContent = confirmationModalEl.querySelector('.modal-content');
            let iconHtml = '';
            if (isSuccess) {
                iconHtml = `<div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-emerald-100"><i data-lucide="check" class="h-6 w-6 text-emerald-600"></i></div>`;
            } else if (isError) {
                iconHtml = `<div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100"><i data-lucide="alert-triangle" class="h-6 w-6 text-red-600"></i></div>`;
            } else {
                iconHtml = `<div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-indigo-100"><i data-lucide="help-circle" class="w-6 w-6 text-indigo-600"></i></div>`;
            }

            modalContent.innerHTML = `
                <div class="p-8">
                    <div class="text-center">
                        ${iconHtml}
                        <h3 class="mt-5 text-lg font-medium text-gray-900">${title}</h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500">${message}</p>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse rounded-b-2xl">
                    <button type="button" id="confirm-action-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 text-base font-medium text-white ${confirmButtonClass} sm:ml-3 sm:w-auto sm:text-sm">
                        ${(isSuccess || isError) ? 'Close' : 'Confirm'}
                    </button>
                    ${showCancel ? `<button type="button" id="cancel-action-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">Cancel</button>` : ''}
                </div>
            `;

            const confirmBtn = modalContent.querySelector('#confirm-action-btn');
            confirmBtn.onclick = () => {
                onConfirm();
            };
            
            if (showCancel) {
                modalContent.querySelector('#cancel-action-btn').onclick = () => closeModal('confirmation-modal');
            }
            
            lucide.createIcons();
            showModal(confirmationModalEl);
        }


        // --- NOTIFICATION FUNCTIONS ---
        async function createNotification(userId, message, link, associatedJobId = null) {
            if (!userId) return;
            try {
                await addDoc(collection(db, "notifications"), {
                    userId: userId,
                    message: message,
                    link: link,
                    jobId: associatedJobId,
                    timestamp: Timestamp.now(),
                    isRead: false
                });
            } catch (error) {
                console.error("Error creating notification: ", error);
            }
        }

        function handleNotificationClick(view, jobId) {
            handleNavigate(view);
            if (jobId) {
                if (view === 'seekerApplications' || view === 'findJobs') {
                    selectJob(jobId);
                } else if (view === 'recruiterPipeline') {
                    state.pipelineSelectedJobId = jobId;
                    // The view will re-render automatically on navigation
                }
            }
            closeModal('notification-modal'); // Assuming a mobile modal might exist
            document.getElementById('notification-dropdown').classList.add('hidden');
        }

        async function markNotificationsAsRead() {
            const unreadNotifications = state.notifications.filter(n => !n.isRead);
            if (unreadNotifications.length === 0) return;

            const updatePromises = unreadNotifications.map(n => {
                const notifDocRef = doc(db, "notifications", n.id);
                return updateDoc(notifDocRef, { isRead: true });
            });

            try {
                await Promise.all(updatePromises);
            } catch (error) {
                console.error("Error marking notifications as read: ", error);
            }
        }

        function showToast(message) {
            const toastContainer = document.getElementById('toast-container');
            if (!toastContainer) return;
            const toastId = `toast-${Date.now()}`;
            const toastHTML = `
                <div id="${toastId}" class="toast bg-white rounded-lg shadow-lg p-4 max-w-sm w-full border-l-4 border-indigo-500">
                    <div class="flex items-start">
                        <div class="flex-shrink-0 pt-0.5">
                            <i data-lucide="info" class="w-5 h-5 text-indigo-500"></i>
                        </div>
                        <div class="ml-3 w-0 flex-1">
                            <p class="text-sm font-medium text-slate-800">New Notification</p>
                            <p class="mt-1 text-sm text-slate-600">${message}</p>
                        </div>
                        <div class="ml-4 flex-shrink-0 flex">
                            <button onclick="document.getElementById('${toastId}').remove()" class="inline-flex rounded-md bg-white text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                <span class="sr-only">Close</span>
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            toastContainer.insertAdjacentHTML('beforeend', toastHTML);
            lucide.createIcons();
            
            const toastEl = document.getElementById(toastId);
            setTimeout(() => {
                toastEl.classList.add('show');
            }, 10);

            setTimeout(() => {
                toastEl.classList.remove('show');
                setTimeout(() => {
                    if (toastEl) toastEl.remove();
                }, 500);
            }, 5000); // Hide after 5 seconds
        }

        // --- ADMIN USER MANAGEMENT ---
        function showSuspendUserModal(userId, userName, isSuspended) {
            const title = isSuspended ? "Unsuspend User" : "Suspend User";
            const message = `Are you sure you want to ${isSuspended ? 'unsuspend' : 'suspend'} the user ${userName}? ${!isSuspended ? 'They will be logged out immediately.' : ''}`;
            const onConfirm = () => {
                if (isSuspended) {
                    handleUnsuspendUser(userId);
                } else {
                    handleSuspendUser(userId);
                }
                closeModal('confirmation-modal');
            };
            showConfirmationModal(title, message, onConfirm);
        }

        function showDeleteUserModal(userId, userName) {
            const title = "Delete User";
            const message = `Are you sure you want to permanently delete the user ${userName}? This will remove their profile and all associated data. This action cannot be undone.`;
            const onConfirm = () => {
                handleDeleteUser(userId);
                closeModal('confirmation-modal');
            };
            showConfirmationModal(title, message, onConfirm, false, true, true, 'bg-red-600 hover:bg-red-700');
        }

        async function handleSuspendUser(userId) {
            const userDocRef = doc(db, "users", userId);
            try {
                await updateDoc(userDocRef, { suspended: true });
                console.log(`User ${userId} suspended successfully.`);
            } catch (error) {
                console.error("Error suspending user: ", error);
            }
        }

        async function handleUnsuspendUser(userId) {
            const userDocRef = doc(db, "users", userId);
            try {
                await updateDoc(userDocRef, { suspended: false });
                console.log(`User ${userId} unsuspended successfully.`);
            } catch (error) {
                console.error("Error unsuspending user: ", error);
            }
        }

        async function handleDeleteUser(userId) {
            console.log(`Attempting to delete user ${userId} and associated data.`);
            const userDocRef = doc(db, "users", userId);
            const profileDocRef = doc(db, "profiles", userId);
            
            try {
                // In a real app, you'd call a Cloud Function to delete the Firebase Auth user.
                console.log(`[SIMULATION] In a real app, the Auth user for ${userId} would be deleted from Firebase Authentication here.`);
                
                // Delete Firestore documents
                await deleteDoc(userDocRef);
                
                const profileSnap = await getDoc(profileDocRef);
                if (profileSnap.exists()) {
                    await deleteDoc(profileDocRef);
                }

                // Delete user's applications (if they are a seeker)
                const appsQuery = query(collection(db, "applications"), where("candidateId", "==", userId));
                const appsSnapshot = await getDocs(appsQuery);
                const deletePromises = [];
                appsSnapshot.forEach((doc) => {
                    deletePromises.push(deleteDoc(doc.ref));
                });
                await Promise.all(deletePromises);
                
                console.log(`Successfully deleted Firestore data for user ${userId}.`);

            } catch (error) {
                console.error("Error deleting user data: ", error);
                 showConfirmationModal("Deletion Failed", "There was an error deleting the user data.", () => closeModal('confirmation-modal'), false, true, false);
            }
        }

        // --- ADMIN JOB MANAGEMENT ---
        function showAdminDeleteJobModal(jobId, jobTitle) {
            const title = "Delete Job Post";
            const message = `Are you sure you want to permanently delete the job post for "${jobTitle}"? This will also delete all applications and reports associated with it. This action cannot be undone.`;
            const onConfirm = () => {
                handleAdminDeleteJob(jobId);
                closeModal('confirmation-modal');
            };
            showConfirmationModal(title, message, onConfirm, false, true, true, 'bg-red-600 hover:bg-red-700');
        }

        async function handleAdminDeleteJob(jobId) {
            if (!jobId) {
                console.error("No job ID provided for deletion.");
                return;
            }
            console.log(`Attempting to delete job ${jobId} and all associated data.`);
            const jobDocRef = doc(db, "jobs", jobId);

            try {
                // Delete associated applications
                const appsQuery = query(collection(db, "applications"), where("jobId", "==", jobId));
                const appsSnapshot = await getDocs(appsQuery);
                const appDeletePromises = [];
                appsSnapshot.forEach((doc) => {
                    appDeletePromises.push(deleteDoc(doc.ref));
                });
                await Promise.all(appDeletePromises);
                console.log(`${appDeletePromises.length} associated applications deleted.`);

                // Delete associated reports
                const reportsQuery = query(collection(db, "reports"), where("jobId", "==", jobId));
                const reportsSnapshot = await getDocs(reportsQuery);
                const reportDeletePromises = [];
                reportsSnapshot.forEach((doc) => {
                    reportDeletePromises.push(deleteDoc(doc.ref));
                });
                await Promise.all(reportDeletePromises);
                console.log(`${reportDeletePromises.length} associated reports deleted.`);

                // Delete the job document itself
                await deleteDoc(jobDocRef);
                console.log(`Successfully deleted job ${jobId}.`);
                
            } catch (error) {
                console.error("Error deleting job and associated data: ", error);
                showConfirmationModal("Deletion Failed", "There was an error deleting the job data.", () => closeModal('confirmation-modal'), false, true, false);
            }
        }

        async function handleDismissReport(reportId) {
            const reportDocRef = doc(db, "reports", reportId);
            try {
                await deleteDoc(reportDocRef);
                console.log(`Report ${reportId} dismissed successfully.`);
            } catch (error) {
                console.error("Error dismissing report: ", error);
            }
        }


        // --- Make functions globally available ---
        window.handleNavigate = handleNavigate;
        window.handleLogout = handleLogout;
        window.toggleMobileMenu = toggleMobileMenu;
        window.toggleLoginDropdown = toggleLoginDropdown;
        window.showLoginModal = showLoginModal;
        window.closeModal = closeModal;
        window.selectJob = selectJob;
        window.changePage = changePage;
        window.showJobListOnMobile = showJobListOnMobile;
        window.showJobDetails = showJobDetails;
        window.showApplicantsModal = showApplicantsModal;
        window.handleSettingsTab = handleSettingsTab;
        window.handleAdminTab = handleAdminTab;
        window.showForgotPassword = showForgotPassword;
        window.handlePasswordReset = handlePasswordReset;
        window.showPostJobModal = showPostJobModal;
        window.showEditJobModal = showEditJobModal;
        window.handleUpdateJob = handleUpdateJob;
        window.generateJobDescription = generateJobDescription;
        window.showDeleteConfirmation = showDeleteConfirmation;
        window.handleDeleteJob = handleDeleteJob;
        window.timeAgo = timeAgo;
        window.showReportJobModal = showReportJobModal;
        window.handleReportJob = handleReportJob;
        window.togglePasswordVisibility = togglePasswordVisibility;
        window.checkPasswordStrength = checkPasswordStrength;
        window.handleSaveJob = handleSaveJob;
        window.showCvFilterModal = showCvFilterModal;
        window.handleCvFilterChange = handleCvFilterChange;
        window.applyCvFilters = applyCvFilters;
        window.showCandidateDetails = showCandidateDetails;
        window.handleApply = handleApply;
        window.handleUpdateProfile = handleUpdateProfile;
        window.handleUpdateCompanyProfile = handleUpdateCompanyProfile;
        window.handleCvFileSelect = handleCvFileSelect;
        window.handlePhotoFileSelect = handlePhotoFileSelect;
        window.handleDownloadCv = handleDownloadCv;
        window.handleDownloadProfilePdf = handleDownloadProfilePdf;
        window.selectRecruiterJobAndNavigate = selectRecruiterJobAndNavigate;
        window.handleDragStart = handleDragStart;
        window.handleDragOver = handleDragOver;
        window.handleDrop = handleDrop;
        window.handleDragEnter = handleDragEnter;
        window.handleDragLeave = handleDragLeave;
        window.showSuspendUserModal = showSuspendUserModal;
        window.showDeleteUserModal = showDeleteUserModal;
        window.showAdminDeleteJobModal = showAdminDeleteJobModal;
        window.handleDismissReport = handleDismissReport;
        window.handleNotificationClick = handleNotificationClick;


        document.addEventListener('click', function(event) {
            const userMenu = document.getElementById('user-menu');
            if (userMenu && !userMenu.contains(event.target)) {
                const userDropdown = document.getElementById('user-dropdown');
                if (userDropdown) userDropdown.classList.add('hidden');
            }
            
            const loginMenu = document.getElementById('login-menu');
            if (loginMenu && !loginMenu.contains(event.target)) {
                const loginDropdown = document.getElementById('login-dropdown');
                if(loginDropdown) loginDropdown.classList.add('hidden');
            }

            const notificationMenu = document.getElementById('notification-menu');
            const notificationDropdown = document.getElementById('notification-dropdown');
            if (notificationMenu && !notificationMenu.contains(event.target)) {
                if (notificationDropdown) notificationDropdown.classList.add('hidden');
            }
        });

        // Add listeners for notification bell
        document.getElementById('notification-button').addEventListener('click', () => {
            document.getElementById('notification-dropdown').classList.toggle('hidden');
            // If opening, mark as read
            if (!document.getElementById('notification-dropdown').classList.contains('hidden')) {
                markNotificationsAsRead();
            }
        });
        
        document.getElementById('mobile-notification-button').addEventListener('click', () => {
            // For mobile, we might want a full-screen modal instead of a dropdown.
            // For now, let's just log it and mark as read.
            handleNavigate('notifications'); // A potential future view
            markNotificationsAsRead();
            console.log("Mobile notifications opened.");
        });


        // --- FIREBASE REALTIME LISTENERS ---
        function listenToJobs() {
            const q = query(collection(db, "jobs"));
            onSnapshot(q, (querySnapshot) => {
                const jobs = [];
                querySnapshot.forEach((doc) => {
                    jobs.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort jobs in memory by postedDate, descending
                jobs.sort((a, b) => {
                    const dateA = a.postedDate?.toDate() || 0;
                    const dateB = b.postedDate?.toDate() || 0;
                    return dateB - dateA;
                });

                state.jobs = jobs;
                
                // If the selected job no longer exists (e.g., was deleted), update the selection
                if(state.selectedJobId && !state.jobs.find(j => j.id === state.selectedJobId)) {
                     state.selectedJobId = state.jobs.length > 0 ? state.jobs[0].id : null;
                } else if (!state.selectedJobId && state.jobs.length > 0) {
                     state.selectedJobId = state.jobs[0].id;
                }

                // Re-render the current view if it's job-related
                if (['landing', 'findJobs', 'recruiterDashboard', 'recruiterJobs', 'seekerDashboard', 'seekerSavedJobs', 'seekerApplications', 'adminDashboard'].includes(state.currentView)) {
                    updateUI();
                }
            });
        }
        
        function listenToProfiles() {
            const q = query(collection(db, "profiles"));
            onSnapshot(q, (querySnapshot) => {
                const candidates = [];
                querySnapshot.forEach((doc) => {
                    candidates.push({ id: doc.id, ...doc.data() });
                });
                state.candidates = candidates;
                if (['cvDatabase', 'recruiterDashboard', 'recruiterJobs', 'applicants-modal', 'settings', 'adminDashboard'].includes(state.currentView)) {
                    updateUI();
                }
            });
        }

        function listenToUsers() {
            const q = query(collection(db, "users"));
            onSnapshot(q, (querySnapshot) => {
                const users = {};
                querySnapshot.forEach((doc) => {
                    users[doc.id] = doc.data();
                });
                state.allUsers = users;
                if (state.currentView === 'adminDashboard') {
                    updateUI();
                }
            });
        }
        
        function listenToReports() {
            const q = query(collection(db, "reports"));
            onSnapshot(q, (querySnapshot) => {
                const reports = [];
                querySnapshot.forEach((doc) => {
                    reports.push({ id: doc.id, ...doc.data() });
                });
                state.reports = reports;
                if (state.currentView === 'adminDashboard') {
                    updateUI();
                }
            });
        }

        let userListener = null;
        let applicationsListener = null;
        let notificationsListener = null;

        onAuthStateChanged(auth, async (user) => {
            if (userListener) userListener(); // Unsubscribe from previous user listener
            if (applicationsListener) applicationsListener(); // Unsubscribe from previous applications listener
            if (notificationsListener) notificationsListener(); // Unsubscribe


            if (user) {
                const userDocRef = doc(db, "users", user.uid);
                userListener = onSnapshot(userDocRef, (userDocSnap) => {
                    if (userDocSnap.exists()) {
                        const userData = userDocSnap.data();

                        if (userData.suspended) {
                            console.warn(`User ${user.uid} is suspended. Forcing logout.`);
                            signOut(auth);
                            showConfirmationModal(
                                "Account Suspended",
                                "Your account has been suspended by an administrator. Please contact support for assistance.",
                                () => closeModal('confirmation-modal'),
                                false, true, false
                            );
                            return;
                        }

                        const nameParts = userData.name.split(' ');
                        const initials = nameParts.length > 1 
                            ? `${nameParts[0][0]}${nameParts[nameParts.length - 1][0]}` 
                            : nameParts[0].substring(0, 2);

                        const userType = user.email === 'admin@jobaccess.co.za' ? 'admin' : userData.type;

                        state.currentUser = {
                            uid: user.uid,
                            email: user.email,
                            name: userData.name,
                            type: userType,
                            initials: initials.toUpperCase(),
                            photoURL: userData.photoURL
                        };
                        state.savedJobs = userData.savedJobs || [];
                        
                        if(state.currentUser.type === 'seeker') {
                            listenToApplications();
                        } else { // Recruiter or Admin
                            listenToAllApplications();
                        }
                        listenToNotifications();
                        
                        // Check if it's the initial login to redirect
                        const isInitialLogin = !document.getElementById('user-menu').offsetParent;
                        if (isInitialLogin && state.currentView === 'landing') {
                           handleNavigate('dashboard');
                        } else {
                            updateUI();
                        }
                    } else {
                        console.error("User data not found in Firestore. Logging out.");
                        handleLogout();
                    }
                });
            } else {
                state.currentUser = null;
                state.savedJobs = [];
                state.applications = [];
                state.notifications = [];
                handleNavigate('landing');
            }
        });

        function listenToApplications() {
             if (!state.currentUser) return;
             const q = query(collection(db, "applications"), where("candidateId", "==", state.currentUser.uid));
             applicationsListener = onSnapshot(q, (querySnapshot) => {
                const applications = [];
                querySnapshot.forEach((doc) => {
                    applications.push({ id: doc.id, ...doc.data() });
                });
                state.applications = applications;
                 if (['seekerDashboard', 'seekerApplications', 'findJobs', 'recruiterPipeline'].includes(state.currentView)) {
                    updateUI();
                }
             });
        }

        function listenToAllApplications() {
            // For recruiters and admins
            const q = query(collection(db, "applications"));
            applicationsListener = onSnapshot(q, (querySnapshot) => {
                const applications = [];
                querySnapshot.forEach((doc) => {
                    applications.push({ id: doc.id, ...doc.data() });
                });
                state.applications = applications;
                if (['recruiterDashboard', 'recruiterJobs', 'recruiterPipeline', 'adminDashboard'].includes(state.currentView)) {
                    updateUI();
                }
            });
        }

        function listenToNotifications() {
            if (notificationsListener) notificationsListener(); // Unsubscribe from previous listener
            if (!state.currentUser) {
                state.notifications = [];
                updateHeader();
                return;
            }

            const q = query(collection(db, "notifications"), where("userId", "==", state.currentUser.uid), orderBy("timestamp", "desc"));
            notificationsListener = onSnapshot(q, (querySnapshot) => {
                const oldNotifications = [...state.notifications];
                const newNotifications = [];
                querySnapshot.forEach((doc) => {
                    newNotifications.push({ id: doc.id, ...doc.data() });
                });

                // Check for new, unread notifications to show a toast
                if (newNotifications.length > 0) {
                     const latestNotification = newNotifications[0];
                    const isAlreadyPresent = oldNotifications.some(n => n.id === latestNotification.id);
                    // Only show toast if it's a genuinely new notification, not just a read status change
                    const wasJustCreated = (getSimulatedNow().getTime() - latestNotification.timestamp.toDate().getTime()) < 5000; // 5s threshold

                    if (!isAlreadyPresent && wasJustCreated) {
                        showToast(latestNotification.message);
                    }
                }

                state.notifications = newNotifications;
                updateHeader();
            });
        }


        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            generateMockData();
            listenToJobs();
            listenToProfiles();
            listenToUsers();
            listenToReports();
            lucide.createIcons();
            
            // Add event listener for static elements that might be re-rendered
            document.addEventListener('click', function(event) {
                if (event.target.closest('#user-menu-button')) {
                    toggleUserDropdown();
                }
                if (event.target.closest('#login-dropdown-button')) {
                    toggleLoginDropdown();
                }
            });

            updateUI(); // Ensure initial render
        });
    </script>
</body>
</html>











